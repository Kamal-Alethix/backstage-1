{"version":3,"file":"generate-b637bb78.cjs.js","sources":["../../src/commands/generate/generate.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { resolve } from 'path';\nimport { OptionValues } from 'commander';\nimport fs from 'fs-extra';\nimport Docker from 'dockerode';\nimport {\n  TechdocsGenerator,\n  ParsedLocationAnnotation,\n} from '@backstage/plugin-techdocs-node';\nimport { DockerContainerRunner } from '@backstage/backend-common';\nimport { ConfigReader } from '@backstage/config';\nimport {\n  convertTechDocsRefToLocationAnnotation,\n  createLogger,\n} from '../../lib/utility';\nimport { stdout } from 'process';\n\nexport default async function generate(opts: OptionValues) {\n  // Use techdocs-node package to generate docs. Keep consistency between Backstage and CI generating docs.\n  // Docs can be prepared using actions/checkout or git clone, or similar paradigms on CI. The TechDocs CI workflow\n  // will run on the CI pipeline containing the documentation files.\n\n  const logger = createLogger({ verbose: opts.verbose });\n\n  const sourceDir = resolve(opts.sourceDir);\n  const outputDir = resolve(opts.outputDir);\n  const omitTechdocsCorePlugin = opts.omitTechdocsCoreMkdocsPlugin;\n  const dockerImage = opts.dockerImage;\n  const pullImage = opts.pull;\n  const legacyCopyReadmeMdToIndexMd = opts.legacyCopyReadmeMdToIndexMd;\n\n  logger.info(`Using source dir ${sourceDir}`);\n  logger.info(`Will output generated files in ${outputDir}`);\n\n  logger.verbose('Creating output directory if it does not exist.');\n\n  await fs.ensureDir(outputDir);\n\n  const config = new ConfigReader({\n    techdocs: {\n      generator: {\n        runIn: opts.docker ? 'docker' : 'local',\n        dockerImage,\n        pullImage,\n        legacyCopyReadmeMdToIndexMd,\n        mkdocs: {\n          omitTechdocsCorePlugin,\n        },\n      },\n    },\n  });\n\n  // Docker client (conditionally) used by the generators, based on techdocs.generators config.\n  const dockerClient = new Docker();\n  const containerRunner = new DockerContainerRunner({ dockerClient });\n\n  let parsedLocationAnnotation = {} as ParsedLocationAnnotation;\n  if (opts.techdocsRef) {\n    try {\n      parsedLocationAnnotation = convertTechDocsRefToLocationAnnotation(\n        opts.techdocsRef,\n      );\n    } catch (err) {\n      logger.error(err.message);\n    }\n  }\n\n  // Generate docs using @backstage/plugin-techdocs-node\n  const techdocsGenerator = await TechdocsGenerator.fromConfig(config, {\n    logger,\n    containerRunner,\n  });\n\n  logger.info('Generating documentation...');\n\n  await techdocsGenerator.run({\n    inputDir: sourceDir,\n    outputDir,\n    ...(opts.techdocsRef\n      ? {\n          parsedLocationAnnotation,\n        }\n      : {}),\n    logger,\n    etag: opts.etag,\n    ...(process.env.LOG_LEVEL === 'debug' ? { logStream: stdout } : {}),\n  });\n\n  logger.info('Done!');\n}\n"],"names":["createLogger","resolve","fs","config","ConfigReader","Docker","DockerContainerRunner","convertTechDocsRefToLocationAnnotation","TechdocsGenerator","stdout"],"mappings":";;;;;;;;;;;;;;;;;AAae,eAAe,QAAQ,CAAC,IAAI,EAAE;AAC7C,EAAE,MAAM,MAAM,GAAGA,oBAAY,CAAC,EAAE,OAAO,EAAE,IAAI,CAAC,OAAO,EAAE,CAAC,CAAC;AACzD,EAAE,MAAM,SAAS,GAAGC,YAAO,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;AAC5C,EAAE,MAAM,SAAS,GAAGA,YAAO,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;AAC5C,EAAE,MAAM,sBAAsB,GAAG,IAAI,CAAC,4BAA4B,CAAC;AACnE,EAAE,MAAM,WAAW,GAAG,IAAI,CAAC,WAAW,CAAC;AACvC,EAAE,MAAM,SAAS,GAAG,IAAI,CAAC,IAAI,CAAC;AAC9B,EAAE,MAAM,2BAA2B,GAAG,IAAI,CAAC,2BAA2B,CAAC;AACvE,EAAE,MAAM,CAAC,IAAI,CAAC,CAAC,iBAAiB,EAAE,SAAS,CAAC,CAAC,CAAC,CAAC;AAC/C,EAAE,MAAM,CAAC,IAAI,CAAC,CAAC,+BAA+B,EAAE,SAAS,CAAC,CAAC,CAAC,CAAC;AAC7D,EAAE,MAAM,CAAC,OAAO,CAAC,iDAAiD,CAAC,CAAC;AACpE,EAAE,MAAMC,sBAAE,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC;AAChC,EAAE,MAAMC,QAAM,GAAG,IAAIC,mBAAY,CAAC;AAClC,IAAI,QAAQ,EAAE;AACd,MAAM,SAAS,EAAE;AACjB,QAAQ,KAAK,EAAE,IAAI,CAAC,MAAM,GAAG,QAAQ,GAAG,OAAO;AAC/C,QAAQ,WAAW;AACnB,QAAQ,SAAS;AACjB,QAAQ,2BAA2B;AACnC,QAAQ,MAAM,EAAE;AAChB,UAAU,sBAAsB;AAChC,SAAS;AACT,OAAO;AACP,KAAK;AACL,GAAG,CAAC,CAAC;AACL,EAAE,MAAM,YAAY,GAAG,IAAIC,0BAAM,EAAE,CAAC;AACpC,EAAE,MAAM,eAAe,GAAG,IAAIC,mCAAqB,CAAC,EAAE,YAAY,EAAE,CAAC,CAAC;AACtE,EAAE,IAAI,wBAAwB,GAAG,EAAE,CAAC;AACpC,EAAE,IAAI,IAAI,CAAC,WAAW,EAAE;AACxB,IAAI,IAAI;AACR,MAAM,wBAAwB,GAAGC,8CAAsC,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;AAC1F,KAAK,CAAC,OAAO,GAAG,EAAE;AAClB,MAAM,MAAM,CAAC,KAAK,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;AAChC,KAAK;AACL,GAAG;AACH,EAAE,MAAM,iBAAiB,GAAG,MAAMC,oCAAiB,CAAC,UAAU,CAACL,QAAM,EAAE;AACvE,IAAI,MAAM;AACV,IAAI,eAAe;AACnB,GAAG,CAAC,CAAC;AACL,EAAE,MAAM,CAAC,IAAI,CAAC,6BAA6B,CAAC,CAAC;AAC7C,EAAE,MAAM,iBAAiB,CAAC,GAAG,CAAC;AAC9B,IAAI,QAAQ,EAAE,SAAS;AACvB,IAAI,SAAS;AACb,IAAI,GAAG,IAAI,CAAC,WAAW,GAAG;AAC1B,MAAM,wBAAwB;AAC9B,KAAK,GAAG,EAAE;AACV,IAAI,MAAM;AACV,IAAI,IAAI,EAAE,IAAI,CAAC,IAAI;AACnB,IAAI,GAAG,OAAO,CAAC,GAAG,CAAC,SAAS,KAAK,OAAO,GAAG,EAAE,SAAS,EAAEM,gBAAM,EAAE,GAAG,EAAE;AACrE,GAAG,CAAC,CAAC;AACL,EAAE,MAAM,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;AACvB;;;;"}