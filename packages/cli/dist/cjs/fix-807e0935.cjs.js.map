{"version":3,"file":"fix-807e0935.cjs.js","sources":["../../src/commands/fix.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { paths } from '../lib/paths';\nimport { ESLint } from 'eslint';\nimport { join as joinPath, basename } from 'path';\nimport fs from 'fs-extra';\nimport { isChildPath } from '@backstage/cli-common';\nimport { PackageGraph } from '../lib/monorepo';\n\nfunction isTestPath(filePath: string) {\n  if (!isChildPath(joinPath(paths.targetDir, 'src'), filePath)) {\n    return true;\n  }\n  const name = basename(filePath);\n  return (\n    name.startsWith('setupTests.') ||\n    name.includes('.test.') ||\n    name.includes('.stories.')\n  );\n}\n\nexport async function command() {\n  const pkgJsonPath = paths.resolveTarget('package.json');\n  const pkg = await fs.readJson(pkgJsonPath);\n  if (pkg.workspaces) {\n    throw new Error(\n      'Adding dependencies to the workspace root is not supported',\n    );\n  }\n\n  const packages = await PackageGraph.listTargetPackages();\n  const localPackageVersions = new Map(\n    packages.map(p => [p.packageJson.name, p.packageJson.version]),\n  );\n\n  const eslint = new ESLint({\n    cwd: paths.targetDir,\n    overrideConfig: {\n      plugins: ['monorepo'],\n      rules: {\n        'import/no-extraneous-dependencies': [\n          'error',\n          {\n            devDependencies: [\n              `!${joinPath(paths.targetDir, 'src/**')}`,\n              joinPath(paths.targetDir, 'src/**/*.test.*'),\n              joinPath(paths.targetDir, 'src/**/*.stories.*'),\n              joinPath(paths.targetDir, 'src/setupTests.*'),\n            ],\n            optionalDependencies: true,\n            peerDependencies: true,\n            bundledDependencies: true,\n          },\n        ],\n      },\n    },\n    extensions: ['jsx', 'ts', 'tsx', 'mjs', 'cjs'],\n  });\n\n  const results = await eslint.lintFiles(['.']);\n\n  const addedDeps = new Set<string>();\n  const addedDevDeps = new Set<string>();\n  const removedDevDeps = new Set<string>();\n\n  for (const result of results) {\n    for (const message of result.messages) {\n      // Just in case\n      if (message.ruleId !== 'import/no-extraneous-dependencies') {\n        continue;\n      }\n\n      const match = message.message.match(/^'([^']*)' should be listed/);\n      if (!match) {\n        continue;\n      }\n      const packageName = match[1];\n      if (!localPackageVersions.has(packageName)) {\n        continue;\n      }\n\n      if (message.message.endsWith('not devDependencies.')) {\n        addedDeps.add(packageName);\n        removedDevDeps.add(packageName);\n      } else if (isTestPath(result.filePath)) {\n        addedDevDeps.add(packageName);\n      } else {\n        addedDeps.add(packageName);\n      }\n    }\n  }\n\n  if (addedDeps.size || addedDevDeps.size || removedDevDeps.size) {\n    for (const name of addedDeps) {\n      if (!pkg.dependencies) {\n        pkg.dependencies = {};\n      }\n      pkg.dependencies[name] = `^${localPackageVersions.get(name)}`;\n    }\n    for (const name of addedDevDeps) {\n      if (!pkg.devDependencies) {\n        pkg.devDependencies = {};\n      }\n      pkg.devDependencies[name] = `^${localPackageVersions.get(name)}`;\n    }\n    for (const name of removedDevDeps) {\n      delete pkg.devDependencies[name];\n    }\n    if (Object.keys(pkg.devDependencies).length === 0) {\n      delete pkg.devDependencies;\n    }\n\n    if (pkg.dependencies) {\n      pkg.dependencies = Object.fromEntries(\n        Object.entries(pkg.dependencies).sort(([a], [b]) => a.localeCompare(b)),\n      );\n    }\n    if (pkg.devDependencies) {\n      pkg.devDependencies = Object.fromEntries(\n        Object.entries(pkg.devDependencies).sort(([a], [b]) =>\n          a.localeCompare(b),\n        ),\n      );\n    }\n\n    await fs.writeJson(pkgJsonPath, pkg, { spaces: 2 });\n  }\n}\n"],"names":["isChildPath","joinPath","paths","basename","fs","PackageGraph","eslint","ESLint"],"mappings":";;;;;;;;;;;;;;;;;;;;AAMA,SAAS,UAAU,CAAC,QAAQ,EAAE;AAC9B,EAAE,IAAI,CAACA,qBAAW,CAACC,SAAQ,CAACC,WAAK,CAAC,SAAS,EAAE,KAAK,CAAC,EAAE,QAAQ,CAAC,EAAE;AAChE,IAAI,OAAO,IAAI,CAAC;AAChB,GAAG;AACH,EAAE,MAAM,IAAI,GAAGC,aAAQ,CAAC,QAAQ,CAAC,CAAC;AAClC,EAAE,OAAO,IAAI,CAAC,UAAU,CAAC,aAAa,CAAC,IAAI,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,IAAI,IAAI,CAAC,QAAQ,CAAC,WAAW,CAAC,CAAC;AACjG,CAAC;AACM,eAAe,OAAO,GAAG;AAChC,EAAE,MAAM,WAAW,GAAGD,WAAK,CAAC,aAAa,CAAC,cAAc,CAAC,CAAC;AAC1D,EAAE,MAAM,GAAG,GAAG,MAAME,sBAAE,CAAC,QAAQ,CAAC,WAAW,CAAC,CAAC;AAC7C,EAAE,IAAI,GAAG,CAAC,UAAU,EAAE;AACtB,IAAI,MAAM,IAAI,KAAK,CAAC,4DAA4D,CAAC,CAAC;AAClF,GAAG;AACH,EAAE,MAAM,QAAQ,GAAG,MAAMC,yBAAY,CAAC,kBAAkB,EAAE,CAAC;AAC3D,EAAE,MAAM,oBAAoB,GAAG,IAAI,GAAG,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,WAAW,CAAC,IAAI,EAAE,CAAC,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC;AACzG,EAAE,MAAMC,QAAM,GAAG,IAAIC,aAAM,CAAC;AAC5B,IAAI,GAAG,EAAEL,WAAK,CAAC,SAAS;AACxB,IAAI,cAAc,EAAE;AACpB,MAAM,OAAO,EAAE,CAAC,UAAU,CAAC;AAC3B,MAAM,KAAK,EAAE;AACb,QAAQ,mCAAmC,EAAE;AAC7C,UAAU,OAAO;AACjB,UAAU;AACV,YAAY,eAAe,EAAE;AAC7B,cAAc,CAAC,CAAC,EAAED,SAAQ,CAACC,WAAK,CAAC,SAAS,EAAE,QAAQ,CAAC,CAAC,CAAC;AACvD,cAAcD,SAAQ,CAACC,WAAK,CAAC,SAAS,EAAE,iBAAiB,CAAC;AAC1D,cAAcD,SAAQ,CAACC,WAAK,CAAC,SAAS,EAAE,oBAAoB,CAAC;AAC7D,cAAcD,SAAQ,CAACC,WAAK,CAAC,SAAS,EAAE,kBAAkB,CAAC;AAC3D,aAAa;AACb,YAAY,oBAAoB,EAAE,IAAI;AACtC,YAAY,gBAAgB,EAAE,IAAI;AAClC,YAAY,mBAAmB,EAAE,IAAI;AACrC,WAAW;AACX,SAAS;AACT,OAAO;AACP,KAAK;AACL,IAAI,UAAU,EAAE,CAAC,KAAK,EAAE,IAAI,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,CAAC;AAClD,GAAG,CAAC,CAAC;AACL,EAAE,MAAM,OAAO,GAAG,MAAMI,QAAM,CAAC,SAAS,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC;AAChD,EAAE,MAAM,SAAS,mBAAmB,IAAI,GAAG,EAAE,CAAC;AAC9C,EAAE,MAAM,YAAY,mBAAmB,IAAI,GAAG,EAAE,CAAC;AACjD,EAAE,MAAM,cAAc,mBAAmB,IAAI,GAAG,EAAE,CAAC;AACnD,EAAE,KAAK,MAAM,MAAM,IAAI,OAAO,EAAE;AAChC,IAAI,KAAK,MAAM,OAAO,IAAI,MAAM,CAAC,QAAQ,EAAE;AAC3C,MAAM,IAAI,OAAO,CAAC,MAAM,KAAK,mCAAmC,EAAE;AAClE,QAAQ,SAAS;AACjB,OAAO;AACP,MAAM,MAAM,KAAK,GAAG,OAAO,CAAC,OAAO,CAAC,KAAK,CAAC,6BAA6B,CAAC,CAAC;AACzE,MAAM,IAAI,CAAC,KAAK,EAAE;AAClB,QAAQ,SAAS;AACjB,OAAO;AACP,MAAM,MAAM,WAAW,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC;AACnC,MAAM,IAAI,CAAC,oBAAoB,CAAC,GAAG,CAAC,WAAW,CAAC,EAAE;AAClD,QAAQ,SAAS;AACjB,OAAO;AACP,MAAM,IAAI,OAAO,CAAC,OAAO,CAAC,QAAQ,CAAC,sBAAsB,CAAC,EAAE;AAC5D,QAAQ,SAAS,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;AACnC,QAAQ,cAAc,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;AACxC,OAAO,MAAM,IAAI,UAAU,CAAC,MAAM,CAAC,QAAQ,CAAC,EAAE;AAC9C,QAAQ,YAAY,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;AACtC,OAAO,MAAM;AACb,QAAQ,SAAS,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;AACnC,OAAO;AACP,KAAK;AACL,GAAG;AACH,EAAE,IAAI,SAAS,CAAC,IAAI,IAAI,YAAY,CAAC,IAAI,IAAI,cAAc,CAAC,IAAI,EAAE;AAClE,IAAI,KAAK,MAAM,IAAI,IAAI,SAAS,EAAE;AAClC,MAAM,IAAI,CAAC,GAAG,CAAC,YAAY,EAAE;AAC7B,QAAQ,GAAG,CAAC,YAAY,GAAG,EAAE,CAAC;AAC9B,OAAO;AACP,MAAM,GAAG,CAAC,YAAY,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,oBAAoB,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;AACpE,KAAK;AACL,IAAI,KAAK,MAAM,IAAI,IAAI,YAAY,EAAE;AACrC,MAAM,IAAI,CAAC,GAAG,CAAC,eAAe,EAAE;AAChC,QAAQ,GAAG,CAAC,eAAe,GAAG,EAAE,CAAC;AACjC,OAAO;AACP,MAAM,GAAG,CAAC,eAAe,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,oBAAoB,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;AACvE,KAAK;AACL,IAAI,KAAK,MAAM,IAAI,IAAI,cAAc,EAAE;AACvC,MAAM,OAAO,GAAG,CAAC,eAAe,CAAC,IAAI,CAAC,CAAC;AACvC,KAAK;AACL,IAAI,IAAI,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,eAAe,CAAC,CAAC,MAAM,KAAK,CAAC,EAAE;AACvD,MAAM,OAAO,GAAG,CAAC,eAAe,CAAC;AACjC,KAAK;AACL,IAAI,IAAI,GAAG,CAAC,YAAY,EAAE;AAC1B,MAAM,GAAG,CAAC,YAAY,GAAG,MAAM,CAAC,WAAW,CAAC,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,aAAa,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;AACrH,KAAK;AACL,IAAI,IAAI,GAAG,CAAC,eAAe,EAAE;AAC7B,MAAM,GAAG,CAAC,eAAe,GAAG,MAAM,CAAC,WAAW,CAAC,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,eAAe,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,aAAa,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;AAC3H,KAAK;AACL,IAAI,MAAMF,sBAAE,CAAC,SAAS,CAAC,WAAW,EAAE,GAAG,EAAE,EAAE,MAAM,EAAE,CAAC,EAAE,CAAC,CAAC;AACxD,GAAG;AACH;;;;"}