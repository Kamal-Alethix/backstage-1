{"version":3,"file":"server-2f47c254.cjs.js","sources":["../../src/lib/bundler/server.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport fs from 'fs-extra';\nimport webpack from 'webpack';\nimport WebpackDevServer from 'webpack-dev-server';\nimport openBrowser from 'react-dev-utils/openBrowser';\nimport { createConfig, resolveBaseUrl } from './config';\nimport { ServeOptions } from './types';\nimport { resolveBundlingPaths } from './paths';\n\nexport async function serveBundle(options: ServeOptions) {\n  const url = resolveBaseUrl(options.frontendConfig);\n\n  const host =\n    options.frontendConfig.getOptionalString('app.listen.host') || url.hostname;\n  const port =\n    options.frontendConfig.getOptionalNumber('app.listen.port') ||\n    Number(url.port) ||\n    (url.protocol === 'https:' ? 443 : 80);\n\n  const paths = resolveBundlingPaths(options);\n  const pkgPath = paths.targetPackageJson;\n  const pkg = await fs.readJson(pkgPath);\n  const config = await createConfig(paths, {\n    ...options,\n    isDev: true,\n    baseUrl: url,\n  });\n  const compiler = webpack(config);\n\n  const server = new WebpackDevServer(\n    compiler as any,\n    {\n      hot: !process.env.CI,\n      devMiddleware: {\n        publicPath: config.output?.publicPath as string,\n        stats: 'errors-warnings',\n      },\n      static: paths.targetPublic\n        ? {\n            publicPath: config.output?.publicPath as string,\n            directory: paths.targetPublic,\n          }\n        : undefined,\n      historyApiFallback: {\n        // Paths with dots should still use the history fallback.\n        // See https://github.com/facebookincubator/create-react-app/issues/387.\n        disableDotRule: true,\n      },\n      https: url.protocol === 'https:',\n      host,\n      port,\n      proxy: pkg.proxy,\n      // When the dev server is behind a proxy, the host and public hostname differ\n      allowedHosts: [url.hostname],\n      client: {\n        webSocketURL: 'auto://0.0.0.0:0/ws',\n      },\n    } as any,\n  );\n\n  await new Promise<void>((resolve, reject) => {\n    server.listen(port, host, (err?: Error) => {\n      if (err) {\n        reject(err);\n        return;\n      }\n\n      openBrowser(url.href);\n      resolve();\n    });\n  });\n\n  const waitForExit = async () => {\n    for (const signal of ['SIGINT', 'SIGTERM'] as const) {\n      process.on(signal, () => {\n        server.close();\n        // exit instead of resolve. The process is shutting down and resolving a promise here logs an error\n        process.exit();\n      });\n    }\n\n    // Block indefinitely and wait for the interrupt signal\n    return new Promise(() => {});\n  };\n\n  return waitForExit;\n}\n"],"names":["resolveBaseUrl","paths","resolveBundlingPaths","fs","createConfig","webpack","WebpackDevServer","openBrowser"],"mappings":"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"}