{"version":3,"file":"packageScripts-e500e2cc.cjs.js","sources":["../../src/commands/migrate/packageScripts.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport fs from 'fs-extra';\nimport { resolve as resolvePath } from 'path';\nimport { PackageGraph } from '../../lib/monorepo';\nimport { getRoleFromPackage, getRoleInfo, PackageRole } from '../../lib/role';\n\nconst configArgPattern = /--config[=\\s][^\\s$]+/;\n\nconst noStartRoles: PackageRole[] = ['cli', 'common-library'];\n\nexport async function command() {\n  const packages = await PackageGraph.listTargetPackages();\n\n  await Promise.all(\n    packages.map(async ({ dir, packageJson }) => {\n      const role = getRoleFromPackage(packageJson);\n      if (!role) {\n        return;\n      }\n\n      const roleInfo = getRoleInfo(role);\n      const hasStart = !noStartRoles.includes(role);\n      const needsPack = !(roleInfo.output.includes('bundle') || role === 'cli');\n      const scripts = packageJson.scripts ?? {};\n\n      const startCmd = ['start'];\n      if (scripts.start?.includes('--check')) {\n        startCmd.push('--check');\n      }\n      if (scripts.start?.includes('--config')) {\n        startCmd.push(...(scripts.start.match(configArgPattern) ?? []));\n      }\n\n      const buildCmd = ['build'];\n      if (scripts.build?.includes('--minify')) {\n        buildCmd.push('--minify');\n      }\n      if (scripts.build?.includes('--experimental-type-build')) {\n        buildCmd.push('--experimental-type-build');\n      }\n      if (scripts.build?.includes('--config')) {\n        buildCmd.push(...(scripts.build.match(configArgPattern) ?? []));\n      }\n\n      // For test scripts we keep all existing flags except for --passWithNoTests, since that's now default\n      const testCmd = ['test'];\n      if (scripts.test?.startsWith('backstage-cli test')) {\n        const args = scripts.test\n          .slice('backstage-cli test'.length)\n          .split(' ')\n          .filter(Boolean);\n        if (args.includes('--passWithNoTests')) {\n          args.splice(args.indexOf('--passWithNoTests'), 1);\n        }\n        testCmd.push(...args);\n      }\n\n      const expectedScripts = {\n        ...(hasStart && {\n          start: `backstage-cli package ${startCmd.join(' ')}`,\n        }),\n        build: `backstage-cli package ${buildCmd.join(' ')}`,\n        lint: 'backstage-cli package lint',\n        test: `backstage-cli package ${testCmd.join(' ')}`,\n        clean: 'backstage-cli package clean',\n        ...(needsPack && {\n          postpack: 'backstage-cli package postpack',\n          prepack: 'backstage-cli package prepack',\n        }),\n      };\n\n      let changed = false;\n      const currentScripts: Record<string, string | undefined> =\n        (packageJson.scripts = packageJson.scripts || {});\n\n      for (const [name, value] of Object.entries(expectedScripts)) {\n        const currentScript = currentScripts[name];\n\n        const isMissing = !currentScript;\n        const isDifferent = currentScript !== value;\n        const isBackstageScript = currentScript?.includes('backstage-cli');\n        if (isMissing || (isDifferent && isBackstageScript)) {\n          changed = true;\n          currentScripts[name] = value;\n        }\n      }\n\n      if (changed) {\n        console.log(`Updating scripts for ${packageJson.name}`);\n        await fs.writeJson(resolvePath(dir, 'package.json'), packageJson, {\n          spaces: 2,\n        });\n      }\n    }),\n  );\n}\n"],"names":["PackageGraph","getRoleFromPackage","getRoleInfo","fs","resolvePath"],"mappings":"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"}