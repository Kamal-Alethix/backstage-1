{"version":3,"file":"lint-3510eb94.cjs.js","sources":["../../src/commands/repo/lint.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport chalk from 'chalk';\nimport { OptionValues } from 'commander';\nimport { relative as relativePath } from 'path';\nimport { PackageGraph, ExtendedPackageJSON } from '../../lib/monorepo';\nimport { runWorkerQueueThreads } from '../../lib/parallel';\nimport { paths } from '../../lib/paths';\n\nfunction depCount(pkg: ExtendedPackageJSON) {\n  const deps = pkg.dependencies ? Object.keys(pkg.dependencies).length : 0;\n  const devDeps = pkg.devDependencies\n    ? Object.keys(pkg.devDependencies).length\n    : 0;\n  return deps + devDeps;\n}\n\nexport async function command(opts: OptionValues): Promise<void> {\n  let packages = await PackageGraph.listTargetPackages();\n\n  if (opts.since) {\n    const graph = PackageGraph.fromPackages(packages);\n    packages = await graph.listChangedPackages({ ref: opts.since });\n  }\n\n  // Packages are ordered from most to least number of dependencies, as a\n  // very cheap way of guessing which packages are more likely to be larger.\n  packages.sort((a, b) => depCount(b.packageJson) - depCount(a.packageJson));\n\n  // This formatter uses the cwd to format file paths, so let's have that happen from the root instead\n  if (opts.format === 'eslint-formatter-friendly') {\n    process.chdir(paths.targetRoot);\n  }\n\n  // Make sure lint output is colored unless the user explicitly disabled it\n  if (!process.env.FORCE_COLOR) {\n    process.env.FORCE_COLOR = '1';\n  }\n\n  const resultsList = await runWorkerQueueThreads({\n    items: packages.map(pkg => ({\n      fullDir: pkg.dir,\n      relativeDir: relativePath(paths.targetRoot, pkg.dir),\n    })),\n    workerData: {\n      fix: Boolean(opts.fix),\n      format: opts.format as string | undefined,\n    },\n    workerFactory: async ({ fix, format }) => {\n      const { ESLint } = require('eslint');\n\n      return async ({\n        fullDir,\n        relativeDir,\n      }): Promise<{ relativeDir: string; resultText: string }> => {\n        // Bit of a hack to make file resolutions happen from the correct directory\n        // since some lint rules don't respect the cwd of ESLint\n        process.cwd = () => fullDir;\n\n        const start = Date.now();\n        const eslint = new ESLint({\n          cwd: fullDir,\n          fix,\n          extensions: ['js', 'jsx', 'ts', 'tsx', 'mjs', 'cjs'],\n        });\n        const formatter = await eslint.loadFormatter(format);\n\n        const results = await eslint.lintFiles(['.']);\n\n        const count = String(results.length).padStart(3);\n        const time = ((Date.now() - start) / 1000).toFixed(2);\n        console.log(`Checked ${count} files in ${relativeDir} ${time}s`);\n\n        if (fix) {\n          await ESLint.outputFixes(results);\n        }\n\n        const resultText = formatter.format(results);\n\n        return { relativeDir, resultText };\n      };\n    },\n  });\n\n  let failed = false;\n  for (const { relativeDir, resultText } of resultsList) {\n    if (resultText) {\n      console.log();\n      console.log(chalk.red(`Lint failed in ${relativeDir}:`));\n      console.log(resultText.trimLeft());\n\n      failed = true;\n    }\n  }\n\n  if (failed) {\n    process.exit(1);\n  }\n}\n"],"names":["PackageGraph","paths","runWorkerQueueThreads","relativePath","chalk"],"mappings":"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"}