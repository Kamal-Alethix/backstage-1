{"version":3,"file":"test-d40d6d84.cjs.js","sources":["../../src/commands/test.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Command, OptionValues } from 'commander';\nimport { paths } from '../lib/paths';\nimport { runCheck } from '../lib/run';\n\nfunction includesAnyOf(hayStack: string[], ...needles: string[]) {\n  for (const needle of needles) {\n    if (hayStack.includes(needle)) {\n      return true;\n    }\n  }\n  return false;\n}\n\nexport default async (_opts: OptionValues, cmd: Command) => {\n  // all args are forwarded to jest\n  let parent = cmd;\n  while (parent.parent) {\n    parent = parent.parent;\n  }\n  const allArgs = parent.args as string[];\n  const args = allArgs.slice(allArgs.indexOf('test') + 1);\n\n  // Only include our config if caller isn't passing their own config\n  if (!includesAnyOf(args, '-c', '--config')) {\n    args.push('--config', paths.resolveOwn('config/jest.js'));\n  }\n\n  if (!includesAnyOf(args, '--no-passWithNoTests', '--passWithNoTests=false')) {\n    args.push('--passWithNoTests');\n  }\n\n  // Run in watch mode unless in CI, coverage mode, or running all tests\n  if (\n    !process.env.CI &&\n    !args.includes('--coverage') &&\n    // explicitly no watching\n    !includesAnyOf(args, '--no-watch', '--watch=false', '--watchAll=false') &&\n    // already watching\n    !includesAnyOf(args, '--watch', '--watchAll')\n  ) {\n    const isGitRepo = () =>\n      runCheck('git', 'rev-parse', '--is-inside-work-tree');\n    const isMercurialRepo = () => runCheck('hg', '--cwd', '.', 'root');\n\n    if ((await isGitRepo()) || (await isMercurialRepo())) {\n      args.push('--watch');\n    } else {\n      args.push('--watchAll');\n    }\n  }\n\n  // This is the only thing that is not implemented by jest.run(), so we do it here instead\n  // https://github.com/facebook/jest/blob/cd8828f7bbec6e55b4df5e41e853a5133c4a3ee1/packages/jest-cli/bin/jest.js#L12\n  if (!process.env.NODE_ENV) {\n    (process.env as any).NODE_ENV = 'test';\n  }\n\n  // This is to have a consistent timezone for when running tests that involve checking\n  // the formatting of date/times.\n  // https://stackoverflow.com/questions/56261381/how-do-i-set-a-timezone-in-my-jest-config\n  if (!process.env.TZ) {\n    process.env.TZ = 'UTC';\n  }\n\n  // eslint-disable-next-line jest/no-jest-import\n  await require('jest').run(args);\n};\n"],"names":["paths","runCheck"],"mappings":";;;;;;;;;;;;;AAEA,SAAS,aAAa,CAAC,QAAQ,EAAE,GAAG,OAAO,EAAE;AAC7C,EAAE,KAAK,MAAM,MAAM,IAAI,OAAO,EAAE;AAChC,IAAI,IAAI,QAAQ,CAAC,QAAQ,CAAC,MAAM,CAAC,EAAE;AACnC,MAAM,OAAO,IAAI,CAAC;AAClB,KAAK;AACL,GAAG;AACH,EAAE,OAAO,KAAK,CAAC;AACf,CAAC;AACD,WAAe,OAAO,KAAK,EAAE,GAAG,KAAK;AACrC,EAAE,IAAI,MAAM,GAAG,GAAG,CAAC;AACnB,EAAE,OAAO,MAAM,CAAC,MAAM,EAAE;AACxB,IAAI,MAAM,GAAG,MAAM,CAAC,MAAM,CAAC;AAC3B,GAAG;AACH,EAAE,MAAM,OAAO,GAAG,MAAM,CAAC,IAAI,CAAC;AAC9B,EAAE,MAAM,IAAI,GAAG,OAAO,CAAC,KAAK,CAAC,OAAO,CAAC,OAAO,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC;AAC1D,EAAE,IAAI,CAAC,aAAa,CAAC,IAAI,EAAE,IAAI,EAAE,UAAU,CAAC,EAAE;AAC9C,IAAI,IAAI,CAAC,IAAI,CAAC,UAAU,EAAEA,WAAK,CAAC,UAAU,CAAC,gBAAgB,CAAC,CAAC,CAAC;AAC9D,GAAG;AACH,EAAE,IAAI,CAAC,aAAa,CAAC,IAAI,EAAE,sBAAsB,EAAE,yBAAyB,CAAC,EAAE;AAC/E,IAAI,IAAI,CAAC,IAAI,CAAC,mBAAmB,CAAC,CAAC;AACnC,GAAG;AACH,EAAE,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,EAAE,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,YAAY,CAAC,IAAI,CAAC,aAAa,CAAC,IAAI,EAAE,YAAY,EAAE,eAAe,EAAE,kBAAkB,CAAC,IAAI,CAAC,aAAa,CAAC,IAAI,EAAE,SAAS,EAAE,YAAY,CAAC,EAAE;AACnL,IAAI,MAAM,SAAS,GAAG,MAAMC,YAAQ,CAAC,KAAK,EAAE,WAAW,EAAE,uBAAuB,CAAC,CAAC;AAClF,IAAI,MAAM,eAAe,GAAG,MAAMA,YAAQ,CAAC,IAAI,EAAE,OAAO,EAAE,GAAG,EAAE,MAAM,CAAC,CAAC;AACvE,IAAI,IAAI,MAAM,SAAS,EAAE,IAAI,MAAM,eAAe,EAAE,EAAE;AACtD,MAAM,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;AAC3B,KAAK,MAAM;AACX,MAAM,IAAI,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;AAC9B,KAAK;AACL,GAAG;AACH,EAAE,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,QAAQ,EAAE;AAC7B,IAAI,OAAO,CAAC,GAAG,CAAC,QAAQ,GAAG,MAAM,CAAC;AAClC,GAAG;AACH,EAAE,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,EAAE,EAAE;AACvB,IAAI,OAAO,CAAC,GAAG,CAAC,EAAE,GAAG,KAAK,CAAC;AAC3B,GAAG;AACH,EAAE,MAAM,OAAO,CAAC,MAAM,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;AAClC,CAAC;;;;"}