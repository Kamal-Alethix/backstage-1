{"version":3,"file":"packages-9866e85e.cjs.js","sources":["../../src/lib/versioning/packages.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport minimatch from 'minimatch';\nimport { getPackages } from '@manypkg/get-packages';\nimport { runPlain } from '../../lib/run';\nimport { NotFoundError } from '../errors';\n\nconst DEP_TYPES = [\n  'dependencies',\n  'devDependencies',\n  'peerDependencies',\n  'optionalDependencies',\n] as const;\n\n// Package data as returned by `yarn info`\nexport type YarnInfoInspectData = {\n  name: string;\n  'dist-tags': Record<string, string>;\n  versions: string[];\n  time: { [version: string]: string };\n};\n\n// Possible `yarn info` output\ntype YarnInfo = {\n  type: 'inspect';\n  data: YarnInfoInspectData | { type: string; data: unknown };\n};\n\ntype PkgVersionInfo = {\n  range: string;\n  name: string;\n  location: string;\n};\n\nexport async function fetchPackageInfo(\n  name: string,\n): Promise<YarnInfoInspectData> {\n  const output = await runPlain('yarn', 'info', '--json', name);\n\n  if (!output) {\n    throw new NotFoundError(`No package information found for package ${name}`);\n  }\n\n  const info = JSON.parse(output) as YarnInfo;\n  if (info.type !== 'inspect') {\n    throw new Error(`Received unknown yarn info for ${name}, ${output}`);\n  }\n\n  return info.data as YarnInfoInspectData;\n}\n\n/** Map all dependencies in the repo as dependency => dependents */\nexport async function mapDependencies(\n  targetDir: string,\n  pattern: string,\n): Promise<Map<string, PkgVersionInfo[]>> {\n  const { packages, root } = await getPackages(targetDir);\n\n  // Include root package.json too\n  packages.push(root);\n\n  const dependencyMap = new Map<string, PkgVersionInfo[]>();\n  for (const pkg of packages) {\n    const deps = DEP_TYPES.flatMap(\n      t => Object.entries(pkg.packageJson[t] ?? {}) as [string, string][],\n    );\n\n    for (const [name, range] of deps) {\n      if (minimatch(name, pattern)) {\n        dependencyMap.set(\n          name,\n          (dependencyMap.get(name) ?? []).concat({\n            range,\n            name: pkg.packageJson.name,\n            location: pkg.dir,\n          }),\n        );\n      }\n    }\n  }\n\n  return dependencyMap;\n}\n"],"names":["runPlain","NotFoundError","getPackages","minimatch"],"mappings":";;;;;;;;;;;AAIA,MAAM,SAAS,GAAG;AAClB,EAAE,cAAc;AAChB,EAAE,iBAAiB;AACnB,EAAE,kBAAkB;AACpB,EAAE,sBAAsB;AACxB,CAAC,CAAC;AACK,eAAe,gBAAgB,CAAC,IAAI,EAAE;AAC7C,EAAE,MAAM,MAAM,GAAG,MAAMA,YAAQ,CAAC,MAAM,EAAE,MAAM,EAAE,QAAQ,EAAE,IAAI,CAAC,CAAC;AAChE,EAAE,IAAI,CAAC,MAAM,EAAE;AACf,IAAI,MAAM,IAAIC,mBAAa,CAAC,CAAC,yCAAyC,EAAE,IAAI,CAAC,CAAC,CAAC,CAAC;AAChF,GAAG;AACH,EAAE,MAAM,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC;AAClC,EAAE,IAAI,IAAI,CAAC,IAAI,KAAK,SAAS,EAAE;AAC/B,IAAI,MAAM,IAAI,KAAK,CAAC,CAAC,+BAA+B,EAAE,IAAI,CAAC,EAAE,EAAE,MAAM,CAAC,CAAC,CAAC,CAAC;AACzE,GAAG;AACH,EAAE,OAAO,IAAI,CAAC,IAAI,CAAC;AACnB,CAAC;AACM,eAAe,eAAe,CAAC,SAAS,EAAE,OAAO,EAAE;AAC1D,EAAE,IAAI,EAAE,CAAC;AACT,EAAE,MAAM,EAAE,QAAQ,EAAE,IAAI,EAAE,GAAG,MAAMC,uBAAW,CAAC,SAAS,CAAC,CAAC;AAC1D,EAAE,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;AACtB,EAAE,MAAM,aAAa,mBAAmB,IAAI,GAAG,EAAE,CAAC;AAClD,EAAE,KAAK,MAAM,GAAG,IAAI,QAAQ,EAAE;AAC9B,IAAI,MAAM,IAAI,GAAG,SAAS,CAAC,OAAO,CAAC,CAAC,CAAC,KAAK;AAC1C,MAAM,IAAI,GAAG,CAAC;AACd,MAAM,OAAO,MAAM,CAAC,OAAO,CAAC,CAAC,GAAG,GAAG,GAAG,CAAC,WAAW,CAAC,CAAC,CAAC,KAAK,IAAI,GAAG,GAAG,GAAG,EAAE,CAAC,CAAC;AAC3E,KAAK,CAAC,CAAC;AACP,IAAI,KAAK,MAAM,CAAC,IAAI,EAAE,KAAK,CAAC,IAAI,IAAI,EAAE;AACtC,MAAM,IAAIC,6BAAS,CAAC,IAAI,EAAE,OAAO,CAAC,EAAE;AACpC,QAAQ,aAAa,CAAC,GAAG,CAAC,IAAI,EAAE,CAAC,CAAC,EAAE,GAAG,aAAa,CAAC,GAAG,CAAC,IAAI,CAAC,KAAK,IAAI,GAAG,EAAE,GAAG,EAAE,EAAE,MAAM,CAAC;AAC1F,UAAU,KAAK;AACf,UAAU,IAAI,EAAE,GAAG,CAAC,WAAW,CAAC,IAAI;AACpC,UAAU,QAAQ,EAAE,GAAG,CAAC,GAAG;AAC3B,SAAS,CAAC,CAAC,CAAC;AACZ,OAAO;AACP,KAAK;AACL,GAAG;AACH,EAAE,OAAO,aAAa,CAAC;AACvB;;;;;"}