{"version":3,"file":"serve-480b380a.cjs.js","sources":["../../src/commands/app/serve.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport fs from 'fs-extra';\nimport chalk from 'chalk';\nimport uniq from 'lodash/uniq';\nimport { OptionValues } from 'commander';\nimport { serveBundle } from '../../lib/bundler';\nimport { loadCliConfig } from '../../lib/config';\nimport { paths } from '../../lib/paths';\nimport { Lockfile } from '../../lib/versioning';\nimport { forbiddenDuplicatesFilter, includedFilter } from '../versions/lint';\n\nexport default async (opts: OptionValues) => {\n  const lockFilePath = paths.resolveTargetRoot('yarn.lock');\n  if (fs.existsSync(lockFilePath)) {\n    try {\n      const lockfile = await Lockfile.load(lockFilePath);\n      const result = lockfile.analyze({\n        filter: includedFilter,\n      });\n      const problemPackages = [...result.newVersions, ...result.newRanges]\n        .map(({ name }) => name)\n        .filter(name => forbiddenDuplicatesFilter(name));\n\n      if (problemPackages.length > 0) {\n        console.log(\n          chalk.yellow(\n            `⚠️ Some of the following packages may be outdated or have duplicate installations:\n\n              ${uniq(problemPackages).join(', ')}\n            `,\n          ),\n        );\n        console.log(\n          chalk.yellow(\n            `⚠️ The following command may fix the issue, but it could also be an issue within one of your dependencies:\n\n              yarn backstage-cli versions:check --fix\n            `,\n          ),\n        );\n      }\n    } catch (error) {\n      console.log(\n        chalk.yellow(\n          `⚠️ Unable to parse yarn.lock file properly:\n\n            ${error}\n\n            skipping analyzer for outdated or duplicate installations\n          `,\n        ),\n      );\n    }\n  } else {\n    console.log(\n      chalk.yellow(\n        `⚠️ Unable to find yarn.lock file:\n\n          skipping analyzer for outdated or duplicate installations\n        `,\n      ),\n    );\n  }\n\n  const { name } = await fs.readJson(paths.resolveTarget('package.json'));\n  const waitForExit = await serveBundle({\n    entry: 'src/index',\n    checksEnabled: opts.check,\n    ...(await loadCliConfig({\n      args: opts.config,\n      fromPackage: name,\n      withFilteredKeys: true,\n    })),\n  });\n\n  await waitForExit();\n};\n"],"names":["paths","fs","Lockfile","includedFilter","forbiddenDuplicatesFilter","chalk","uniq","serveBundle","loadCliConfig"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAQA,YAAe,OAAO,IAAI,KAAK;AAC/B,EAAE,MAAM,YAAY,GAAGA,WAAK,CAAC,iBAAiB,CAAC,WAAW,CAAC,CAAC;AAC5D,EAAE,IAAIC,sBAAE,CAAC,UAAU,CAAC,YAAY,CAAC,EAAE;AACnC,IAAI,IAAI;AACR,MAAM,MAAM,QAAQ,GAAG,MAAMC,iBAAQ,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;AACzD,MAAM,MAAM,MAAM,GAAG,QAAQ,CAAC,OAAO,CAAC;AACtC,QAAQ,MAAM,EAAEC,mBAAc;AAC9B,OAAO,CAAC,CAAC;AACT,MAAM,MAAM,eAAe,GAAG,CAAC,GAAG,MAAM,CAAC,WAAW,EAAE,GAAG,MAAM,CAAC,SAAS,CAAC,CAAC,GAAG,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,KAAK,KAAK,CAAC,CAAC,MAAM,CAAC,CAAC,KAAK,KAAKC,8BAAyB,CAAC,KAAK,CAAC,CAAC,CAAC;AAC/J,MAAM,IAAI,eAAe,CAAC,MAAM,GAAG,CAAC,EAAE;AACtC,QAAQ,OAAO,CAAC,GAAG,CAACC,yBAAK,CAAC,MAAM,CAAC,CAAC;AAClC;AACA,cAAc,EAAEC,wBAAI,CAAC,eAAe,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;AACjD,YAAY,CAAC,CAAC,CAAC,CAAC;AAChB,QAAQ,OAAO,CAAC,GAAG,CAACD,yBAAK,CAAC,MAAM,CAAC,CAAC;AAClC;AACA;AACA,YAAY,CAAC,CAAC,CAAC,CAAC;AAChB,OAAO;AACP,KAAK,CAAC,OAAO,KAAK,EAAE;AACpB,MAAM,OAAO,CAAC,GAAG,CAACA,yBAAK,CAAC,MAAM,CAAC,CAAC;AAChC;AACA,YAAY,EAAE,KAAK,CAAC;AACpB;AACA;AACA,UAAU,CAAC,CAAC,CAAC,CAAC;AACd,KAAK;AACL,GAAG,MAAM;AACT,IAAI,OAAO,CAAC,GAAG,CAACA,yBAAK,CAAC,MAAM,CAAC,CAAC;AAC9B;AACA;AACA,QAAQ,CAAC,CAAC,CAAC,CAAC;AACZ,GAAG;AACH,EAAE,MAAM,EAAE,IAAI,EAAE,GAAG,MAAMJ,sBAAE,CAAC,QAAQ,CAACD,WAAK,CAAC,aAAa,CAAC,cAAc,CAAC,CAAC,CAAC;AAC1E,EAAE,MAAM,WAAW,GAAG,MAAMO,kBAAW,CAAC;AACxC,IAAI,KAAK,EAAE,WAAW;AACtB,IAAI,aAAa,EAAE,IAAI,CAAC,KAAK;AAC7B,IAAI,GAAG,MAAMC,oBAAa,CAAC;AAC3B,MAAM,IAAI,EAAE,IAAI,CAAC,MAAM;AACvB,MAAM,WAAW,EAAE,IAAI;AACvB,MAAM,gBAAgB,EAAE,IAAI;AAC5B,KAAK,CAAC;AACN,GAAG,CAAC,CAAC;AACL,EAAE,MAAM,WAAW,EAAE,CAAC;AACtB,CAAC;;;;"}