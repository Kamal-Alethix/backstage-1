{"version":3,"file":"index-7053ecd8.cjs.js","sources":["../../src/commands/start/startBackend.ts","../../src/commands/start/startFrontend.ts","../../src/commands/start/command.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport fs from 'fs-extra';\nimport { paths } from '../../lib/paths';\nimport { serveBackend } from '../../lib/bundler';\n\ninterface StartBackendOptions {\n  checksEnabled: boolean;\n  inspectEnabled: boolean;\n  inspectBrkEnabled: boolean;\n}\n\nexport async function startBackend(options: StartBackendOptions) {\n  // Cleaning dist/ before we start the dev process helps work around an issue\n  // where we end up with the entrypoint executing multiple times, causing\n  // a port bind conflict among other things.\n  await fs.remove(paths.resolveTarget('dist'));\n\n  const waitForExit = await serveBackend({\n    entry: 'src/index',\n    checksEnabled: options.checksEnabled,\n    inspectEnabled: options.inspectEnabled,\n    inspectBrkEnabled: options.inspectBrkEnabled,\n  });\n\n  await waitForExit();\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport fs from 'fs-extra';\nimport chalk from 'chalk';\nimport uniq from 'lodash/uniq';\nimport { serveBundle } from '../../lib/bundler';\nimport { loadCliConfig } from '../../lib/config';\nimport { paths } from '../../lib/paths';\nimport { Lockfile } from '../../lib/versioning';\nimport { includedFilter } from '../versions/lint';\n\ninterface StartAppOptions {\n  verifyVersions?: boolean;\n  entry: string;\n\n  checksEnabled: boolean;\n  configPaths: string[];\n}\n\nexport async function startFrontend(options: StartAppOptions) {\n  if (options.verifyVersions) {\n    const lockfile = await Lockfile.load(paths.resolveTargetRoot('yarn.lock'));\n    const result = lockfile.analyze({\n      filter: includedFilter,\n    });\n    const problemPackages = [...result.newVersions, ...result.newRanges].map(\n      ({ name }) => name,\n    );\n\n    if (problemPackages.length > 1) {\n      console.log(\n        chalk.yellow(\n          `⚠️   Some of the following packages may be outdated or have duplicate installations:\n\n          ${uniq(problemPackages).join(', ')}\n        `,\n        ),\n      );\n      console.log(\n        chalk.yellow(\n          `⚠️   This can be resolved using the following command:\n\n          yarn backstage-cli versions:check --fix\n      `,\n        ),\n      );\n    }\n  }\n\n  const { name } = await fs.readJson(paths.resolveTarget('package.json'));\n  const config = await loadCliConfig({\n    args: options.configPaths,\n    fromPackage: name,\n    withFilteredKeys: true,\n  });\n\n  const appBaseUrl = config.frontendConfig.getString('app.baseUrl');\n  const backendBaseUrl = config.frontendConfig.getString('backend.baseUrl');\n  if (appBaseUrl === backendBaseUrl) {\n    console.log(\n      chalk.yellow(\n        `⚠️   Conflict between app baseUrl and backend baseUrl:\n\n    app.baseUrl:     ${appBaseUrl}\n    backend.baseUrl: ${appBaseUrl}\n\n    Must have unique hostname and/or ports.\n\n    This can be resolved by changing app.baseUrl and backend.baseUrl to point to their respective local development ports.\n`,\n      ),\n    );\n  }\n\n  const waitForExit = await serveBundle({\n    entry: options.entry,\n    checksEnabled: options.checksEnabled,\n    ...config,\n  });\n\n  await waitForExit();\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { OptionValues } from 'commander';\nimport { startBackend } from './startBackend';\nimport { startFrontend } from './startFrontend';\nimport { findRoleFromCommand } from '../../lib/role';\n\nexport async function command(opts: OptionValues): Promise<void> {\n  const role = await findRoleFromCommand(opts);\n\n  const options = {\n    configPaths: opts.config as string[],\n    checksEnabled: Boolean(opts.check),\n    inspectEnabled: Boolean(opts.inspect),\n    inspectBrkEnabled: Boolean(opts.inspectBrk),\n  };\n\n  switch (role) {\n    case 'backend':\n    case 'backend-plugin':\n    case 'backend-plugin-module':\n    case 'node-library':\n      return startBackend(options);\n    case 'frontend':\n      return startFrontend({\n        ...options,\n        entry: 'src/index',\n        verifyVersions: true,\n      });\n    case 'web-library':\n    case 'frontend-plugin':\n    case 'frontend-plugin-module':\n      return startFrontend({ entry: 'dev/index', ...options });\n    default:\n      throw new Error(\n        `Start command is not supported for package role '${role}'`,\n      );\n  }\n}\n"],"names":["fs","paths","serveBackend","Lockfile","includedFilter","chalk","uniq","config","loadCliConfig","serveBundle","findRoleFromCommand"],"mappings":"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"}