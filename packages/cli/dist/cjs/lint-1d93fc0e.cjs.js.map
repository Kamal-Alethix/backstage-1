{"version":3,"file":"lint-1d93fc0e.cjs.js","sources":["../../src/commands/versions/lint.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { OptionValues } from 'commander';\nimport { Lockfile } from '../../lib/versioning';\nimport { paths } from '../../lib/paths';\nimport partition from 'lodash/partition';\n\n// Packages that we try to avoid duplicates for\nconst INCLUDED = [/^@backstage\\//];\n\nexport const includedFilter = (name: string) =>\n  INCLUDED.some(pattern => pattern.test(name));\n\n// Packages that are not allowed to have any duplicates\nconst FORBID_DUPLICATES = [\n  /^@backstage\\/core-app-api$/,\n  /^@backstage\\/plugin-/,\n];\n\n// There are some packages that ARE explicitly allowed to have duplicates since\n// they handle that appropriately. This takes precedence over FORBID_DUPLICATES\n// above.\nconst ALLOW_DUPLICATES = [\n  /^@backstage\\/core-plugin-api$/,\n  // Duplicates of libraries are OK\n  // TODO(Rugvip): Check this using package role instead\n  /^@backstage\\/plugin-.*-react$/,\n  /^@backstage\\/plugin-.*-node$/,\n  /^@backstage\\/plugin-.*-common$/,\n];\n\nexport const forbiddenDuplicatesFilter = (name: string) =>\n  FORBID_DUPLICATES.some(pattern => pattern.test(name)) &&\n  !ALLOW_DUPLICATES.some(pattern => pattern.test(name));\n\nexport default async (cmd: OptionValues) => {\n  const fix = Boolean(cmd.fix);\n\n  let success = true;\n\n  const lockfile = await Lockfile.load(paths.resolveTargetRoot('yarn.lock'));\n  const result = lockfile.analyze({\n    filter: includedFilter,\n  });\n\n  logArray(\n    result.invalidRanges,\n    \"The following packages versions are invalid and can't be analyzed:\",\n    e => `  ${e.name} @ ${e.range}`,\n  );\n\n  if (fix) {\n    lockfile.replaceVersions(result.newVersions);\n    await lockfile.save();\n  } else {\n    const [newVersionsForbidden, newVersionsAllowed] = partition(\n      result.newVersions,\n      ({ name }) => forbiddenDuplicatesFilter(name),\n    );\n    if (newVersionsForbidden.length && !fix) {\n      success = false;\n    }\n\n    logArray(\n      newVersionsForbidden,\n      'The following packages must be deduplicated, this can be done automatically with --fix',\n      e =>\n        `  ${e.name} @ ${e.range} bumped from ${e.oldVersion} to ${e.newVersion}`,\n    );\n    logArray(\n      newVersionsAllowed,\n      'The following packages can be deduplicated, this can be done automatically with --fix',\n      e =>\n        `  ${e.name} @ ${e.range} bumped from ${e.oldVersion} to ${e.newVersion}`,\n    );\n  }\n\n  const [newRangesForbidden, newRangesAllowed] = partition(\n    result.newRanges,\n    ({ name }) => forbiddenDuplicatesFilter(name),\n  );\n  if (newRangesForbidden.length) {\n    success = false;\n  }\n\n  logArray(\n    newRangesForbidden,\n    'The following packages must be deduplicated by updating dependencies in package.json',\n    e => `  ${e.name} @ ${e.oldRange} should be changed to ${e.newRange}`,\n  );\n  logArray(\n    newRangesAllowed,\n    'The following packages can be deduplicated by updating dependencies in package.json',\n    e => `  ${e.name} @ ${e.oldRange} should be changed to ${e.newRange}`,\n  );\n\n  if (!success) {\n    throw new Error('Failed versioning check');\n  }\n};\n\nfunction logArray<T>(arr: T[], header: string, each: (item: T) => string) {\n  if (arr.length === 0) {\n    return;\n  }\n\n  console.log(header);\n  console.log();\n  for (const e of arr) {\n    console.log(each(e));\n  }\n  console.log();\n}\n"],"names":["Lockfile","paths","partition"],"mappings":"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"}