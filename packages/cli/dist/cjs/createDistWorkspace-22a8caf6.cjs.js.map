{"version":3,"file":"createDistWorkspace-22a8caf6.cjs.js","sources":["../../src/lib/packager/copyPackageDist.ts","../../src/lib/packager/createDistWorkspace.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport fs from 'fs-extra';\nimport npmPackList from 'npm-packlist';\nimport { join as joinPath, resolve as resolvePath } from 'path';\n\nconst SKIPPED_KEYS = ['access', 'registry', 'tag', 'alphaTypes', 'betaTypes'];\n\nfunction resolveEntrypoint(pkg: any, name: string) {\n  const targetEntry = pkg.publishConfig[name] || pkg[name];\n  return targetEntry && joinPath('..', targetEntry);\n}\n\n// Writes e.g. alpha/package.json\nasync function writeReleaseStageEntrypoint(\n  pkg: any,\n  stage: 'alpha' | 'beta',\n  targetDir: string,\n) {\n  await fs.ensureDir(resolvePath(targetDir, stage));\n  await fs.writeJson(\n    resolvePath(targetDir, stage, 'package.json'),\n    {\n      name: pkg.name,\n      version: pkg.version,\n      main: resolveEntrypoint(pkg, 'main'),\n      module: resolveEntrypoint(pkg, 'module'),\n      browser: resolveEntrypoint(pkg, 'browser'),\n      types: joinPath('..', pkg.publishConfig[`${stage}Types`]),\n    },\n    { encoding: 'utf8', spaces: 2 },\n  );\n}\n\nexport async function copyPackageDist(packageDir: string, targetDir: string) {\n  const pkgPath = resolvePath(packageDir, 'package.json');\n  const pkgContent = await fs.readFile(pkgPath, 'utf8');\n  const pkg = JSON.parse(pkgContent);\n\n  const publishConfig = pkg.publishConfig ?? {};\n  for (const key of Object.keys(publishConfig)) {\n    if (!SKIPPED_KEYS.includes(key)) {\n      pkg[key] = publishConfig[key];\n    }\n  }\n\n  // We remove the dependencies from package.json of packages that are marked\n  // as bundled, so that yarn doesn't try to install them.\n  if (pkg.bundled) {\n    delete pkg.dependencies;\n    delete pkg.devDependencies;\n    delete pkg.peerDependencies;\n    delete pkg.optionalDependencies;\n  }\n\n  // Write the modified package.json so that the file listing is correct\n  await fs.writeJson(pkgPath, pkg, { encoding: 'utf8', spaces: 2 });\n\n  // Lists all dist files, respecting .npmignore, files field in package.json, etc.\n  const filePaths = await npmPackList({ path: packageDir });\n\n  await fs.ensureDir(targetDir);\n  for (const filePath of filePaths.sort()) {\n    await fs.copy(\n      resolvePath(packageDir, filePath),\n      resolvePath(targetDir, filePath),\n    );\n  }\n\n  if (publishConfig.alphaTypes) {\n    await writeReleaseStageEntrypoint(pkg, 'alpha', targetDir);\n  }\n  if (publishConfig.betaTypes) {\n    await writeReleaseStageEntrypoint(pkg, 'beta', targetDir);\n  }\n\n  // Restore package.json\n  await fs.writeFile(pkgPath, pkgContent, 'utf8');\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport chalk from 'chalk';\nimport fs from 'fs-extra';\nimport {\n  join as joinPath,\n  resolve as resolvePath,\n  relative as relativePath,\n} from 'path';\nimport { tmpdir } from 'os';\nimport tar, { CreateOptions } from 'tar';\nimport partition from 'lodash/partition';\nimport { paths } from '../paths';\nimport { run } from '../run';\nimport {\n  dependencies as cliDependencies,\n  devDependencies as cliDevDependencies,\n} from '../../../package.json';\nimport { PackageGraph, PackageGraphNode } from '../monorepo';\nimport {\n  BuildOptions,\n  buildPackages,\n  getOutputsForRole,\n  Output,\n} from '../builder';\nimport { copyPackageDist } from './copyPackageDist';\nimport { getRoleInfo } from '../role';\n\n// These packages aren't safe to pack in parallel since the CLI depends on them\nconst UNSAFE_PACKAGES = [\n  ...Object.keys(cliDependencies),\n  ...Object.keys(cliDevDependencies),\n];\n\ntype FileEntry =\n  | string\n  | {\n      src: string;\n      dest: string;\n    };\n\ntype Options = {\n  /**\n   * Target directory for the dist workspace, defaults to a temporary directory\n   */\n  targetDir?: string;\n\n  /**\n   * Files to copy into the target workspace.\n   *\n   * Defaults to ['yarn.lock', 'package.json'].\n   */\n  files?: FileEntry[];\n\n  /**\n   * If set to true, the target packages are built before they are packaged into the workspace.\n   */\n  buildDependencies?: boolean;\n\n  /**\n   * When `buildDependencies` is set, this list of packages will not be built even if they are dependencies.\n   */\n  buildExcludes?: string[];\n\n  /**\n   * Controls amount of parallelism in some build steps.\n   */\n  parallelism?: number;\n\n  /**\n   * If set, creates a skeleton tarball that contains all package.json files\n   * with the same structure as the workspace dir.\n   */\n  skeleton?: 'skeleton.tar' | 'skeleton.tar.gz';\n};\n\n/**\n * Uses `yarn pack` to package local packages and unpacks them into a dist workspace.\n * The target workspace will end up containing dist version of each package and\n * will be suitable for packaging e.g. into a docker image.\n *\n * This creates a structure that is functionally similar to if the packages were\n * installed from npm, but uses Yarn workspaces to link to them at runtime.\n */\nexport async function createDistWorkspace(\n  packageNames: string[],\n  options: Options = {},\n) {\n  const targetDir =\n    options.targetDir ??\n    (await fs.mkdtemp(resolvePath(tmpdir(), 'dist-workspace')));\n\n  const packages = await PackageGraph.listTargetPackages();\n  const packageGraph = PackageGraph.fromPackages(packages);\n  const targetNames = packageGraph.collectPackageNames(packageNames, node => {\n    // Don't include dependencies of packages that are marked as bundled\n    if (node.packageJson.bundled) {\n      return undefined;\n    }\n\n    return node.publishedLocalDependencies.keys();\n  });\n  const targets = Array.from(targetNames).map(name => packageGraph.get(name)!);\n\n  if (options.buildDependencies) {\n    const exclude = options.buildExcludes ?? [];\n\n    const toBuild = new Set(\n      targets.map(_ => _.name).filter(name => !exclude.includes(name)),\n    );\n\n    const standardBuilds = new Array<BuildOptions>();\n    const customBuild = new Array<string>();\n\n    for (const pkg of packages) {\n      if (!toBuild.has(pkg.packageJson.name)) {\n        continue;\n      }\n      const role = pkg.packageJson.backstage?.role;\n      if (!role) {\n        console.warn(\n          `Building ${pkg.packageJson.name} separately because it has no role`,\n        );\n        customBuild.push(pkg.packageJson.name);\n        continue;\n      }\n\n      const buildScript = pkg.packageJson.scripts?.build;\n      if (!buildScript) {\n        customBuild.push(pkg.packageJson.name);\n        continue;\n      }\n\n      if (!buildScript.startsWith('backstage-cli package build')) {\n        console.warn(\n          `Building ${pkg.packageJson.name} separately because it has a custom build script, '${buildScript}'`,\n        );\n        customBuild.push(pkg.packageJson.name);\n        continue;\n      }\n\n      if (getRoleInfo(role).output.includes('bundle')) {\n        console.warn(\n          `Building ${pkg.packageJson.name} separately because it is a bundled package`,\n        );\n        customBuild.push(pkg.packageJson.name);\n        continue;\n      }\n\n      const outputs = getOutputsForRole(role);\n\n      // No need to build and include types in the production runtime\n      outputs.delete(Output.types);\n\n      if (outputs.size > 0) {\n        standardBuilds.push({\n          targetDir: pkg.dir,\n          outputs: outputs,\n          logPrefix: `${chalk.cyan(relativePath(paths.targetRoot, pkg.dir))}: `,\n          // No need to detect these for the backend builds, we assume no minification or types\n          minify: false,\n          useApiExtractor: false,\n        });\n      }\n    }\n\n    await buildPackages(standardBuilds);\n\n    if (customBuild.length > 0) {\n      const scopeArgs = customBuild.flatMap(name => ['--scope', name]);\n      const lernaArgs =\n        options.parallelism && Number.isInteger(options.parallelism)\n          ? ['--concurrency', options.parallelism.toString()]\n          : [];\n\n      await run('yarn', ['lerna', ...lernaArgs, 'run', ...scopeArgs, 'build'], {\n        cwd: paths.targetRoot,\n      });\n    }\n  }\n\n  await moveToDistWorkspace(targetDir, targets);\n\n  const files: FileEntry[] = options.files ?? ['yarn.lock', 'package.json'];\n\n  for (const file of files) {\n    const src = typeof file === 'string' ? file : file.src;\n    const dest = typeof file === 'string' ? file : file.dest;\n    await fs.copy(paths.resolveTargetRoot(src), resolvePath(targetDir, dest));\n  }\n\n  if (options.skeleton) {\n    const skeletonFiles = targets.map(target => {\n      const dir = relativePath(paths.targetRoot, target.dir);\n      return joinPath(dir, 'package.json');\n    });\n\n    await tar.create(\n      {\n        file: resolvePath(targetDir, options.skeleton),\n        cwd: targetDir,\n        portable: true,\n        noMtime: true,\n        gzip: options.skeleton.endsWith('.gz'),\n      } as CreateOptions & { noMtime: boolean },\n      skeletonFiles,\n    );\n  }\n\n  return targetDir;\n}\n\nconst FAST_PACK_SCRIPTS = [\n  undefined,\n  'backstage-cli prepack',\n  'backstage-cli package prepack',\n];\n\nasync function moveToDistWorkspace(\n  workspaceDir: string,\n  localPackages: PackageGraphNode[],\n): Promise<void> {\n  const [fastPackPackages, slowPackPackages] = partition(localPackages, pkg =>\n    FAST_PACK_SCRIPTS.includes(pkg.packageJson.scripts?.prepack),\n  );\n\n  // New an improved flow where we avoid calling `yarn pack`\n  await Promise.all(\n    fastPackPackages.map(async target => {\n      console.log(`Moving ${target.name} into dist workspace`);\n\n      const outputDir = relativePath(paths.targetRoot, target.dir);\n      const absoluteOutputPath = resolvePath(workspaceDir, outputDir);\n      await copyPackageDist(target.dir, absoluteOutputPath);\n    }),\n  );\n\n  // Old flow is below, which calls `yarn pack` and extracts the tarball\n\n  async function pack(target: PackageGraphNode, archive: string) {\n    console.log(`Repacking ${target.name} into dist workspace`);\n    const archivePath = resolvePath(workspaceDir, archive);\n\n    await run('yarn', ['pack', '--filename', archivePath], {\n      cwd: target.dir,\n    });\n    // TODO(Rugvip): yarn pack doesn't call postpack, once the bug is fixed this can be removed\n    if (target.packageJson?.scripts?.postpack) {\n      await run('yarn', ['postpack'], { cwd: target.dir });\n    }\n\n    const outputDir = relativePath(paths.targetRoot, target.dir);\n    const absoluteOutputPath = resolvePath(workspaceDir, outputDir);\n    await fs.ensureDir(absoluteOutputPath);\n\n    await tar.extract({\n      file: archivePath,\n      cwd: absoluteOutputPath,\n      strip: 1,\n    });\n    await fs.remove(archivePath);\n\n    // We remove the dependencies from package.json of packages that are marked\n    // as bundled, so that yarn doesn't try to install them.\n    if (target.packageJson.bundled) {\n      const pkgJson = await fs.readJson(\n        resolvePath(absoluteOutputPath, 'package.json'),\n      );\n      delete pkgJson.dependencies;\n      delete pkgJson.devDependencies;\n      delete pkgJson.peerDependencies;\n      delete pkgJson.optionalDependencies;\n\n      await fs.writeJson(\n        resolvePath(absoluteOutputPath, 'package.json'),\n        pkgJson,\n        {\n          spaces: 2,\n        },\n      );\n    }\n  }\n\n  const [unsafePackages, safePackages] = partition(slowPackPackages, p =>\n    UNSAFE_PACKAGES.includes(p.name),\n  );\n\n  // The unsafe package are packed first one by one in order to avoid race conditions\n  // where the CLI is being executed with broken dependencies.\n  for (const target of unsafePackages) {\n    await pack(target, `temp-package.tgz`);\n  }\n\n  // Repacking in parallel is much faster and safe for all packages outside of the Backstage repo\n  await Promise.all(\n    safePackages.map(async (target, index) =>\n      pack(target, `temp-package-${index}.tgz`),\n    ),\n  );\n}\n"],"names":["joinPath","fs","resolvePath","npmPackList","cliDependencies","cliDevDependencies","tmpdir","PackageGraph","getRoleInfo","getOutputsForRole","Output","chalk","relativePath","paths","buildPackages","run","tar","partition"],"mappings":"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"}