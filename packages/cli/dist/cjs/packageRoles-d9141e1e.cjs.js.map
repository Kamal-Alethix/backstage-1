{"version":3,"file":"packageRoles-d9141e1e.cjs.js","sources":["../../src/lib/role/packageRoles.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { z } from 'zod';\nimport fs from 'fs-extra';\nimport { OptionValues } from 'commander';\nimport { paths } from '../paths';\nimport { PackageRole, PackageRoleInfo } from './types';\n\nconst packageRoleInfos: PackageRoleInfo[] = [\n  {\n    role: 'frontend',\n    platform: 'web',\n    output: ['bundle'],\n  },\n  {\n    role: 'backend',\n    platform: 'node',\n    output: ['bundle'],\n  },\n  {\n    role: 'cli',\n    platform: 'node',\n    output: ['cjs'],\n  },\n  {\n    role: 'web-library',\n    platform: 'web',\n    output: ['types', 'esm'],\n  },\n  {\n    role: 'node-library',\n    platform: 'node',\n    output: ['types', 'cjs'],\n  },\n  {\n    role: 'common-library',\n    platform: 'common',\n    output: ['types', 'esm', 'cjs'],\n  },\n  {\n    role: 'frontend-plugin',\n    platform: 'web',\n    output: ['types', 'esm'],\n  },\n  {\n    role: 'frontend-plugin-module',\n    platform: 'web',\n    output: ['types', 'esm'],\n  },\n  {\n    role: 'backend-plugin',\n    platform: 'node',\n    output: ['types', 'cjs'],\n  },\n  {\n    role: 'backend-plugin-module',\n    platform: 'node',\n    output: ['types', 'cjs'],\n  },\n];\n\nexport function getRoleInfo(role: string): PackageRoleInfo {\n  const roleInfo = packageRoleInfos.find(r => r.role === role);\n  if (!roleInfo) {\n    throw new Error(`Unknown package role '${role}'`);\n  }\n  return roleInfo;\n}\n\nconst readSchema = z.object({\n  name: z.string().optional(),\n  backstage: z\n    .object({\n      role: z.string().optional(),\n    })\n    .optional(),\n});\n\nexport function getRoleFromPackage(pkgJson: unknown): PackageRole | undefined {\n  const pkg = readSchema.parse(pkgJson);\n\n  // If there's an explicit role, use that.\n  if (pkg.backstage) {\n    const { role } = pkg.backstage;\n    if (!role) {\n      throw new Error(\n        `Package ${pkg.name} must specify a role in the \"backstage\" field`,\n      );\n    }\n\n    return getRoleInfo(role).role;\n  }\n\n  return undefined;\n}\n\nexport async function findRoleFromCommand(\n  opts: OptionValues,\n): Promise<PackageRole> {\n  if (opts.role) {\n    return getRoleInfo(opts.role)?.role;\n  }\n\n  const pkg = await fs.readJson(paths.resolveTarget('package.json'));\n  const info = getRoleFromPackage(pkg);\n  if (!info) {\n    throw new Error(`Target package must have 'backstage.role' set`);\n  }\n  return info;\n}\n\nconst detectionSchema = z.object({\n  name: z.string().optional(),\n  scripts: z\n    .object({\n      start: z.string().optional(),\n      build: z.string().optional(),\n    })\n    .optional(),\n  publishConfig: z\n    .object({\n      main: z.string().optional(),\n      types: z.string().optional(),\n      module: z.string().optional(),\n    })\n    .optional(),\n  main: z.string().optional(),\n  types: z.string().optional(),\n  module: z.string().optional(),\n});\n\nexport function detectRoleFromPackage(\n  pkgJson: unknown,\n): PackageRole | undefined {\n  const pkg = detectionSchema.parse(pkgJson);\n\n  if (pkg.scripts?.start?.includes('app:serve')) {\n    return 'frontend';\n  }\n  if (pkg.scripts?.build?.includes('backend:bundle')) {\n    return 'backend';\n  }\n  if (pkg.name?.includes('plugin-') && pkg.name?.includes('-backend-module-')) {\n    return 'backend-plugin-module';\n  }\n  if (pkg.name?.includes('plugin-') && pkg.name?.includes('-module-')) {\n    return 'frontend-plugin-module';\n  }\n  if (pkg.scripts?.start?.includes('plugin:serve')) {\n    return 'frontend-plugin';\n  }\n  if (pkg.scripts?.start?.includes('backend:dev')) {\n    return 'backend-plugin';\n  }\n\n  const mainEntry = pkg.publishConfig?.main || pkg.main;\n  const moduleEntry = pkg.publishConfig?.module || pkg.module;\n  const typesEntry = pkg.publishConfig?.types || pkg.types;\n  if (typesEntry) {\n    if (mainEntry && moduleEntry) {\n      return 'common-library';\n    }\n    if (moduleEntry || mainEntry?.endsWith('.esm.js')) {\n      return 'web-library';\n    }\n    if (mainEntry) {\n      return 'node-library';\n    }\n  } else if (mainEntry) {\n    return 'cli';\n  }\n\n  return undefined;\n}\n"],"names":["z","fs","paths"],"mappings":"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"}