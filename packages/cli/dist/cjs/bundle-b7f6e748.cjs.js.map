{"version":3,"file":"bundle-b7f6e748.cjs.js","sources":["../../src/lib/bundler/bundle.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport yn from 'yn';\nimport fs from 'fs-extra';\nimport { resolve as resolvePath } from 'path';\nimport webpack from 'webpack';\nimport {\n  measureFileSizesBeforeBuild,\n  printFileSizesAfterBuild,\n} from 'react-dev-utils/FileSizeReporter';\nimport formatWebpackMessages from 'react-dev-utils/formatWebpackMessages';\nimport { createConfig, resolveBaseUrl } from './config';\nimport { BuildOptions } from './types';\nimport { resolveBundlingPaths } from './paths';\nimport chalk from 'chalk';\n\n// TODO(Rugvip): Limits from CRA, we might want to tweak these though.\nconst WARN_AFTER_BUNDLE_GZIP_SIZE = 512 * 1024;\nconst WARN_AFTER_CHUNK_GZIP_SIZE = 1024 * 1024;\n\nexport async function buildBundle(options: BuildOptions) {\n  const { statsJsonEnabled, schema: configSchema } = options;\n\n  const paths = resolveBundlingPaths(options);\n  const config = await createConfig(paths, {\n    ...options,\n    checksEnabled: false,\n    isDev: false,\n    baseUrl: resolveBaseUrl(options.frontendConfig),\n  });\n  const compiler = webpack(config);\n\n  const isCi = yn(process.env.CI, { default: false });\n\n  const previousFileSizes = await measureFileSizesBeforeBuild(paths.targetDist);\n  await fs.emptyDir(paths.targetDist);\n\n  if (paths.targetPublic) {\n    await fs.copy(paths.targetPublic, paths.targetDist, {\n      dereference: true,\n      filter: file => file !== paths.targetHtml,\n    });\n  }\n\n  if (configSchema) {\n    await fs.writeJson(\n      resolvePath(paths.targetDist, '.config-schema.json'),\n      configSchema.serialize(),\n      { spaces: 2 },\n    );\n  }\n\n  const { stats } = await build(compiler, isCi).catch(error => {\n    console.log(chalk.red('Failed to compile.\\n'));\n    throw new Error(`Failed to compile.\\n${error.message || error}`);\n  });\n\n  if (!stats) {\n    throw new Error('No stats returned');\n  }\n\n  if (statsJsonEnabled) {\n    // No @types/bfj\n    await require('bfj').write(\n      resolvePath(paths.targetDist, 'bundle-stats.json'),\n      stats.toJson(),\n    );\n  }\n\n  printFileSizesAfterBuild(\n    stats,\n    previousFileSizes,\n    paths.targetDist,\n    WARN_AFTER_BUNDLE_GZIP_SIZE,\n    WARN_AFTER_CHUNK_GZIP_SIZE,\n  );\n}\n\nasync function build(compiler: webpack.Compiler, isCi: boolean) {\n  const stats = await new Promise<webpack.Stats | undefined>(\n    (resolve, reject) => {\n      compiler.run((err, buildStats) => {\n        if (err) {\n          if (err.message) {\n            const { errors } = formatWebpackMessages({\n              errors: [err.message],\n              warnings: new Array<string>(),\n              _showErrors: true,\n              _showWarnings: true,\n            });\n\n            throw new Error(errors[0]);\n          } else {\n            reject(err);\n          }\n        } else {\n          resolve(buildStats);\n        }\n      });\n    },\n  );\n\n  if (!stats) {\n    throw new Error('No stats provided');\n  }\n\n  const serializedStats = stats.toJson({\n    all: false,\n    warnings: true,\n    errors: true,\n  });\n  // NOTE(freben): The code below that extracts the message part of the errors,\n  // is due to react-dev-utils not yet being compatible with webpack 5. This\n  // may be possible to remove (just passing the serialized stats object\n  // directly into the format function) after a new release of react-dev-utils\n  // has been made available.\n  // See https://github.com/facebook/create-react-app/issues/9880\n  const { errors, warnings } = formatWebpackMessages({\n    errors: serializedStats.errors?.map(e => (e.message ? e.message : e)),\n    warnings: serializedStats.warnings?.map(e => (e.message ? e.message : e)),\n  });\n\n  if (errors.length) {\n    // Only keep the first error. Others are often indicative\n    // of the same problem, but confuse the reader with noise.\n    throw new Error(errors[0]);\n  }\n  if (isCi && warnings.length) {\n    console.log(\n      chalk.yellow(\n        '\\nTreating warnings as errors because process.env.CI = true.\\n',\n      ),\n    );\n    throw new Error(warnings.join('\\n\\n'));\n  }\n\n  return { stats };\n}\n"],"names":["paths","resolveBundlingPaths","createConfig","resolveBaseUrl","webpack","yn","measureFileSizesBeforeBuild","fs","resolvePath","chalk","printFileSizesAfterBuild","formatWebpackMessages"],"mappings":"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"}