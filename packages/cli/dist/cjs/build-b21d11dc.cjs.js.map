{"version":3,"file":"build-b21d11dc.cjs.js","sources":["../../src/commands/repo/build.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport chalk from 'chalk';\nimport { Command, OptionValues } from 'commander';\nimport { relative as relativePath } from 'path';\nimport { buildPackages, getOutputsForRole } from '../../lib/builder';\nimport { PackageGraph } from '../../lib/monorepo';\nimport { ExtendedPackage } from '../../lib/monorepo/PackageGraph';\nimport { runParallelWorkers } from '../../lib/parallel';\nimport { paths } from '../../lib/paths';\nimport { detectRoleFromPackage } from '../../lib/role';\nimport { buildFrontend } from '../build/buildFrontend';\nimport { buildBackend } from '../build/buildBackend';\n\nfunction createScriptOptionsParser(anyCmd: Command, commandPath: string[]) {\n  // Regardless of what command instance is passed in we want to find\n  // the root command and resolve the path from there\n  let rootCmd = anyCmd;\n  while (rootCmd.parent) {\n    rootCmd = rootCmd.parent;\n  }\n\n  // Now find the command that was requested\n  let targetCmd = rootCmd as Command | undefined;\n  for (const name of commandPath) {\n    targetCmd = targetCmd?.commands.find(c => c.name() === name) as\n      | Command\n      | undefined;\n  }\n\n  if (!targetCmd) {\n    throw new Error(\n      `Could not find package command '${commandPath.join(' ')}'`,\n    );\n  }\n  const cmd = targetCmd;\n\n  const expectedScript = `backstage-cli ${commandPath.join(' ')}`;\n\n  return (scriptStr?: string) => {\n    if (!scriptStr || !scriptStr.startsWith(expectedScript)) {\n      return undefined;\n    }\n\n    const argsStr = scriptStr.slice(expectedScript.length).trim();\n\n    // Can't clone or copy or even use commands as prototype, so we mutate\n    // the necessary members instead, and then reset them once we're done\n    const currentOpts = (cmd as any)._optionValues;\n    const currentStore = (cmd as any)._storeOptionsAsProperties;\n\n    const result: Record<string, any> = {};\n    (cmd as any)._storeOptionsAsProperties = false;\n    (cmd as any)._optionValues = result;\n\n    // Triggers the writing of options to the result object\n    cmd.parseOptions(argsStr.split(' '));\n\n    (cmd as any)._storeOptionsAsProperties = currentOpts;\n    (cmd as any)._optionValues = currentStore;\n\n    return result;\n  };\n}\n\nexport async function command(opts: OptionValues, cmd: Command): Promise<void> {\n  let packages = await PackageGraph.listTargetPackages();\n\n  if (opts.since) {\n    const graph = PackageGraph.fromPackages(packages);\n    const changedPackages = await graph.listChangedPackages({\n      ref: opts.since,\n    });\n    const withDevDependents = graph.collectPackageNames(\n      changedPackages.map(pkg => pkg.name),\n      pkg => pkg.localDevDependents.keys(),\n    );\n    packages = Array.from(withDevDependents).map(name => graph.get(name)!);\n  }\n\n  const apps = new Array<ExtendedPackage>();\n  const backends = new Array<ExtendedPackage>();\n\n  const parseBuildScript = createScriptOptionsParser(cmd, ['package', 'build']);\n\n  const options = packages.flatMap(pkg => {\n    const role =\n      pkg.packageJson.backstage?.role ?? detectRoleFromPackage(pkg.packageJson);\n    if (!role) {\n      console.warn(`Ignored ${pkg.packageJson.name} because it has no role`);\n      return [];\n    }\n\n    if (role === 'frontend') {\n      apps.push(pkg);\n      return [];\n    } else if (role === 'backend') {\n      backends.push(pkg);\n      return [];\n    }\n\n    const outputs = getOutputsForRole(role);\n    if (outputs.size === 0) {\n      console.warn(`Ignored ${pkg.packageJson.name} because it has no output`);\n      return [];\n    }\n\n    const buildOptions = parseBuildScript(pkg.packageJson.scripts?.build);\n    if (!buildOptions) {\n      console.warn(\n        `Ignored ${pkg.packageJson.name} because it does not have a matching build script`,\n      );\n      return [];\n    }\n\n    return {\n      targetDir: pkg.dir,\n      outputs,\n      logPrefix: `${chalk.cyan(relativePath(paths.targetRoot, pkg.dir))}: `,\n      minify: buildOptions.minify,\n      useApiExtractor: buildOptions.experimentalTypeBuild,\n    };\n  });\n\n  console.log('Building packages');\n  await buildPackages(options);\n\n  if (opts.all) {\n    console.log('Building apps');\n    await runParallelWorkers({\n      items: apps,\n      parallelismFactor: 1 / 2,\n      worker: async pkg => {\n        const buildOptions = parseBuildScript(pkg.packageJson.scripts?.build);\n        if (!buildOptions) {\n          console.warn(\n            `Ignored ${pkg.packageJson.name} because it does not have a matching build script`,\n          );\n          return;\n        }\n        await buildFrontend({\n          targetDir: pkg.dir,\n          configPaths: (buildOptions.config as string[]) ?? [],\n          writeStats: Boolean(buildOptions.stats),\n        });\n      },\n    });\n\n    console.log('Building backends');\n    await runParallelWorkers({\n      items: backends,\n      parallelismFactor: 1 / 2,\n      worker: async pkg => {\n        const buildOptions = parseBuildScript(pkg.packageJson.scripts?.build);\n        if (!buildOptions) {\n          console.warn(\n            `Ignored ${pkg.packageJson.name} because it does not have a matching build script`,\n          );\n          return;\n        }\n        await buildBackend({\n          targetDir: pkg.dir,\n          skipBuildDependencies: true,\n        });\n      },\n    });\n  }\n}\n"],"names":["PackageGraph","detectRoleFromPackage","getOutputsForRole","chalk","relativePath","paths","buildPackages","runParallelWorkers","buildFrontend","buildBackend"],"mappings":"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"}