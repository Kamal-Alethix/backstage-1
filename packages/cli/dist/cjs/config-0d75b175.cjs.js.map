{"version":3,"file":"config-0d75b175.cjs.js","sources":["../../src/lib/urls.ts","../../src/lib/config.ts"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nexport function isValidUrl(url: string): boolean {\n  try {\n    // eslint-disable-next-line no-new\n    new URL(url);\n    return true;\n  } catch {\n    return false;\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  ConfigTarget,\n  loadConfig,\n  loadConfigSchema,\n} from '@backstage/config-loader';\nimport { ConfigReader } from '@backstage/config';\nimport { paths } from './paths';\nimport { isValidUrl } from './urls';\nimport { getPackages } from '@manypkg/get-packages';\nimport { PackageGraph } from './monorepo';\n\ntype Options = {\n  args: string[];\n  fromPackage?: string;\n  mockEnv?: boolean;\n  withFilteredKeys?: boolean;\n  withDeprecatedKeys?: boolean;\n  fullVisibility?: boolean;\n};\n\nexport async function loadCliConfig(options: Options) {\n  const configTargets: ConfigTarget[] = [];\n  options.args.forEach(arg => {\n    if (!isValidUrl(arg)) {\n      configTargets.push({ path: paths.resolveTarget(arg) });\n    }\n  });\n\n  // Consider all packages in the monorepo when loading in config\n  const { packages } = await getPackages(paths.targetDir);\n\n  let localPackageNames;\n  if (options.fromPackage) {\n    if (packages.length) {\n      const graph = PackageGraph.fromPackages(packages);\n      localPackageNames = Array.from(\n        graph.collectPackageNames([options.fromPackage], node => {\n          // Workaround for Backstage main repo only, since the CLI has some artificial devDependencies\n          if (node.name === '@backstage/cli') {\n            return undefined;\n          }\n          return node.localDependencies.keys();\n        }),\n      );\n    } else {\n      // No packages: it means that it's not a monorepo (e.g. standalone plugin)\n      localPackageNames = [options.fromPackage];\n    }\n  } else {\n    localPackageNames = packages.map(p => p.packageJson.name);\n  }\n\n  const schema = await loadConfigSchema({\n    dependencies: localPackageNames,\n    // Include the package.json in the project root if it exists\n    packagePaths: [paths.resolveTargetRoot('package.json')],\n  });\n\n  const { appConfigs } = await loadConfig({\n    experimentalEnvFunc: options.mockEnv\n      ? async name => process.env[name] || 'x'\n      : undefined,\n    configRoot: paths.targetRoot,\n    configTargets: configTargets,\n  });\n\n  // printing to stderr to not clobber stdout in case the cli command\n  // outputs structured data (e.g. as config:schema does)\n  process.stderr.write(\n    `Loaded config from ${appConfigs.map(c => c.context).join(', ')}\\n`,\n  );\n\n  try {\n    const frontendAppConfigs = schema.process(appConfigs, {\n      visibility: options.fullVisibility\n        ? ['frontend', 'backend', 'secret']\n        : ['frontend'],\n      withFilteredKeys: options.withFilteredKeys,\n      withDeprecatedKeys: options.withDeprecatedKeys,\n    });\n    const frontendConfig = ConfigReader.fromConfigs(frontendAppConfigs);\n\n    return {\n      schema,\n      appConfigs,\n      frontendConfig,\n      frontendAppConfigs,\n    };\n  } catch (error) {\n    const maybeSchemaError = error as Error & { messages?: string[] };\n    if (maybeSchemaError.messages) {\n      const messages = maybeSchemaError.messages.join('\\n  ');\n      throw new Error(`Configuration does not match schema\\n\\n  ${messages}`);\n    }\n    throw error;\n  }\n}\n"],"names":["paths","getPackages","PackageGraph","loadConfigSchema","loadConfig","ConfigReader"],"mappings":"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"}