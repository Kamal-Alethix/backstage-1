{"version":3,"file":"packageLintConfigs-feff4d05.cjs.js","sources":["../../src/commands/migrate/packageLintConfigs.ts"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport fs from 'fs-extra';\nimport { resolve as resolvePath } from 'path';\nimport { PackageGraph } from '../../lib/monorepo';\nimport { runPlain } from '../../lib/run';\n\nconst PREFIX = `module.exports = require('@backstage/cli/config/eslint-factory')`;\n\nexport async function command() {\n  const packages = await PackageGraph.listTargetPackages();\n\n  const oldConfigs = [\n    require.resolve('@backstage/cli/config/eslint.js'),\n    require.resolve('@backstage/cli/config/eslint.backend.js'),\n  ];\n\n  const configPaths = new Array<string>();\n  await Promise.all(\n    packages.map(async ({ dir, packageJson }) => {\n      const configPath = resolvePath(dir, '.eslintrc.js');\n      if (!(await fs.pathExists(configPath))) {\n        console.log(`Skipping ${packageJson.name}, missing .eslintrc.js`);\n        return;\n      }\n      let existingConfig: Record<string, unknown>;\n      try {\n        existingConfig = require(configPath);\n      } catch (error) {\n        console.log(\n          `Skipping ${packageJson.name}, failed to load .eslintrc.js, ${error}`,\n        );\n        return;\n      }\n\n      // Only transform configs that extend the old config files, and\n      // we remove that entry from the extends array.\n      const extendsArray = (existingConfig.extends as string[]) ?? [];\n      const extendIndex = extendsArray.findIndex(p => oldConfigs.includes(p));\n      if (extendIndex === -1) {\n        console.log(\n          `Skipping ${packageJson.name}, .eslintrc.js does not extend the legacy config`,\n        );\n        return;\n      }\n      extendsArray.splice(extendIndex, 1);\n      if (extendsArray.length === 0) {\n        delete existingConfig.extends;\n      }\n\n      if (Object.keys(existingConfig).length > 0) {\n        await fs.writeFile(\n          configPath,\n          `${PREFIX}(__dirname, ${JSON.stringify(existingConfig, null, 2)});\\n`,\n        );\n      } else {\n        await fs.writeFile(configPath, `${PREFIX}(__dirname);\\n`);\n      }\n      configPaths.push(configPath);\n    }),\n  );\n\n  // If prettier is present, then we run that too\n  let hasPrettier = false;\n  try {\n    require.resolve('prettier');\n    hasPrettier = true;\n  } catch {\n    /* ignore */\n  }\n\n  if (hasPrettier) {\n    await runPlain('prettier', '--write', ...configPaths);\n  }\n}\n"],"names":["PackageGraph","resolvePath","fs","runPlain"],"mappings":"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"}