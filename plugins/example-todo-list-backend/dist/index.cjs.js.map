{"version":3,"file":"index.cjs.js","sources":["../src/service/todos.ts","../src/service/router.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { v4 as uuid } from 'uuid';\nimport { NotFoundError } from '@backstage/errors';\n\nexport type Todo = {\n  title: string;\n  author?: string;\n  id: string;\n  timestamp: number;\n};\n\nexport type TodoFilter = {\n  property: Exclude<keyof Todo, 'timestamp'>;\n  values: Array<string | undefined>;\n};\n\nexport type TodoFilters =\n  | {\n      anyOf: TodoFilters[];\n    }\n  | { allOf: TodoFilters[] }\n  | { not: TodoFilters }\n  | TodoFilter;\n\nconst todos: { [key: string]: Todo } = {};\n\nconst matches = (todo: Todo, filters?: TodoFilters): boolean => {\n  if (!filters) {\n    return true;\n  }\n\n  if ('allOf' in filters) {\n    return filters.allOf.every(filter => matches(todo, filter));\n  }\n\n  if ('anyOf' in filters) {\n    return filters.anyOf.some(filter => matches(todo, filter));\n  }\n\n  if ('not' in filters) {\n    return !matches(todo, filters.not);\n  }\n\n  return filters.values.includes(todo[filters.property]);\n};\n\nexport function add(todo: Omit<Todo, 'id' | 'timestamp'>) {\n  const id = uuid();\n\n  const obj: Todo = { ...todo, id, timestamp: Date.now() };\n  todos[id] = obj;\n  return obj;\n}\n\nexport function getTodo(id: string) {\n  return todos[id];\n}\n\nexport function update({ id, title }: { id: string; title: string }) {\n  let todo = todos[id];\n  if (!todo) {\n    throw new NotFoundError('Item not found');\n  }\n\n  todo = { ...todo, title, timestamp: Date.now() };\n  todos[id] = todo;\n  return todo;\n}\n\nexport function getAll(filter?: TodoFilters) {\n  return Object.values(todos)\n    .filter(value => matches(value, filter))\n    .sort((a, b) => b.timestamp - a.timestamp);\n}\n\n// prepopulate the db\nadd({ title: 'just a note' });\nadd({ title: 'another note' });\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { errorHandler } from '@backstage/backend-common';\nimport express from 'express';\nimport Router from 'express-promise-router';\nimport { Logger } from 'winston';\nimport {\n  IdentityClient,\n  getBearerTokenFromAuthorizationHeader,\n} from '@backstage/plugin-auth-node';\nimport { add, getAll, update } from './todos';\nimport { InputError } from '@backstage/errors';\n\n/**\n * Dependencies of the todo-list router\n *\n * @public\n */\nexport interface RouterOptions {\n  logger: Logger;\n  identity: IdentityClient;\n}\n\n/**\n * Creates an express.Router with some endpoints\n * for creating, editing and deleting todo items.\n *\n * @public\n * @param options - the dependencies of the router\n * @returns an express.Router\n *\n */\nexport async function createRouter(\n  options: RouterOptions,\n): Promise<express.Router> {\n  const { logger, identity } = options;\n\n  const router = Router();\n  router.use(express.json());\n\n  router.get('/health', (_, response) => {\n    logger.info('PONG!');\n    response.send({ status: 'ok' });\n  });\n\n  router.get('/todos', async (_req, res) => {\n    res.json(getAll());\n  });\n\n  router.post('/todos', async (req, res) => {\n    const token = getBearerTokenFromAuthorizationHeader(\n      req.header('authorization'),\n    );\n    let author: string | undefined = undefined;\n\n    const user = token ? await identity.authenticate(token) : undefined;\n    author = user?.identity.userEntityRef;\n\n    if (!isTodoCreateRequest(req.body)) {\n      throw new InputError('Invalid payload');\n    }\n\n    const todo = add({ title: req.body.title, author });\n    res.json(todo);\n  });\n\n  router.put('/todos', async (req, res) => {\n    if (!isTodoUpdateRequest(req.body)) {\n      throw new InputError('Invalid payload');\n    }\n    res.json(update(req.body));\n  });\n\n  router.use(errorHandler());\n  return router;\n}\n\nfunction isTodoCreateRequest(request: any): request is { title: string } {\n  return typeof request?.title === 'string';\n}\n\nfunction isTodoUpdateRequest(\n  request: any,\n): request is { title: string; id: string } {\n  return typeof request?.id === 'string' && isTodoCreateRequest(request);\n}\n"],"names":["uuid","NotFoundError","Router","express","getBearerTokenFromAuthorizationHeader","InputError","errorHandler"],"mappings":"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"}