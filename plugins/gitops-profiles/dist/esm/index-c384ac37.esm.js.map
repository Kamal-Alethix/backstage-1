{"version":3,"file":"index-c384ac37.esm.js","sources":["../../src/components/ClusterPage/ClusterPage.tsx"],"sourcesContent":["/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport React, { useEffect, useState } from 'react';\n\nimport { Link } from '@material-ui/core';\nimport { useParams } from 'react-router-dom';\nimport { gitOpsApiRef, Status } from '../../api';\nimport { transformRunStatus } from '../ProfileCatalog';\n\nimport {\n  Content,\n  Header,\n  Page,\n  Table,\n  Progress,\n  HeaderLabel,\n} from '@backstage/core-components';\nimport { useApi, githubAuthApiRef } from '@backstage/core-plugin-api';\n\nconst ClusterPage = () => {\n  const params = useParams() as { owner: string; repo: string };\n\n  const [pollingLog, setPollingLog] = useState(true);\n  const [runStatus, setRunStatus] = useState<Status[]>([]);\n  const [runLink, setRunLink] = useState<string>('');\n  const [showProgress, setShowProgress] = useState(true);\n\n  const api = useApi(gitOpsApiRef);\n  const githubAuth = useApi(githubAuthApiRef);\n  const [githubAccessToken, setGithubAccessToken] = useState(String);\n  const [githubUsername, setGithubUsername] = useState(String);\n\n  const columns = [\n    { field: 'status', title: 'Status' },\n    { field: 'message', title: 'Message' },\n  ];\n\n  useEffect(() => {\n    const fetchGithubUserInfo = async () => {\n      const accessToken = await githubAuth.getAccessToken(['repo', 'user']);\n      const userInfo = await api.fetchUserInfo({ accessToken });\n      setGithubAccessToken(accessToken);\n      setGithubUsername(userInfo.login);\n    };\n\n    if (!githubAccessToken || !githubUsername) {\n      fetchGithubUserInfo();\n    } else {\n      if (pollingLog) {\n        const interval = setInterval(async () => {\n          const resp = await api.fetchLog({\n            gitHubToken: githubAccessToken,\n            gitHubUser: githubUsername,\n            targetOrg: params.owner,\n            targetRepo: params.repo,\n          });\n\n          setRunStatus(resp.result);\n          setRunLink(resp.link);\n          if (resp.status === 'completed') {\n            setPollingLog(false);\n            setShowProgress(false);\n          }\n        }, 10000);\n        return () => clearInterval(interval);\n      }\n    }\n\n    return () => {};\n  }, [pollingLog, api, params, githubAuth, githubAccessToken, githubUsername]);\n\n  return (\n    <Page themeId=\"home\">\n      <Header title={`Cluster ${params.owner}/${params.repo}`}>\n        <HeaderLabel label=\"Welcome\" value={githubUsername} />\n      </Header>\n      <Content>\n        <Progress hidden={!showProgress} />\n        <Table\n          options={{ search: false, paging: false, toolbar: false }}\n          data={transformRunStatus(runStatus)}\n          columns={columns}\n        />\n        <Link\n          hidden={runLink === ''}\n          rel=\"noopener noreferrer\"\n          href={`${runLink}?check_suite_focus=true`}\n          target=\"_blank\"\n        >\n          Details\n        </Link>\n      </Content>\n    </Page>\n  );\n};\n\nexport default ClusterPage;\n"],"names":[],"mappings":"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"}