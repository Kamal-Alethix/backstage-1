{"version":3,"file":"index.esm.js","sources":["../src/test-utils.tsx"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React, { ReactElement, Fragment } from 'react';\n\n// Shadow DOM support for the simple and complete DOM testing utilities\n// https://github.com/testing-library/dom-testing-library/issues/742#issuecomment-674987855\nimport { screen } from 'testing-library__dom';\nimport { renderToStaticMarkup } from 'react-dom/server';\nimport { Route } from 'react-router-dom';\nimport { act, render } from '@testing-library/react';\n\nimport { wrapInTestApp, TestApiProvider } from '@backstage/test-utils';\nimport { FlatRoutes } from '@backstage/core-app-api';\nimport { ApiRef } from '@backstage/core-plugin-api';\n\nimport {\n  TechDocsAddons,\n  techdocsApiRef,\n  TechDocsEntityMetadata,\n  TechDocsMetadata,\n  techdocsStorageApiRef,\n} from '@backstage/plugin-techdocs-react';\nimport { TechDocsReaderPage, techdocsPlugin } from '@backstage/plugin-techdocs';\nimport { catalogPlugin } from '@backstage/plugin-catalog';\nimport { searchApiRef } from '@backstage/plugin-search-react';\nimport { scmIntegrationsApiRef } from '@backstage/integration-react';\n\nconst techdocsApi = {\n  getTechDocsMetadata: jest.fn(),\n  getEntityMetadata: jest.fn(),\n};\n\nconst techdocsStorageApi = {\n  getApiOrigin: jest.fn(),\n  getBaseUrl: jest.fn(),\n  getEntityDocs: jest.fn(),\n  syncEntityDocs: jest.fn(),\n};\n\nconst searchApi = {\n  query: jest.fn().mockResolvedValue({ results: [] }),\n};\n\nconst scmIntegrationsApi = {\n  fromConfig: jest.fn().mockReturnValue({}),\n};\n\n/** @ignore */\ntype TechDocsAddonTesterTestApiPair<TApi> = TApi extends infer TImpl\n  ? readonly [ApiRef<TApi>, Partial<TImpl>]\n  : never;\n\n/** @ignore */\ntype TechdocsAddonTesterApis<TApiPairs> = {\n  [TIndex in keyof TApiPairs]: TechDocsAddonTesterTestApiPair<\n    TApiPairs[TIndex]\n  >;\n};\n\ntype TechDocsAddonTesterOptions = {\n  dom: ReactElement;\n  entity: Partial<TechDocsEntityMetadata>;\n  metadata: Partial<TechDocsMetadata>;\n  componentId: string;\n  apis: TechdocsAddonTesterApis<any[]>;\n  path: string;\n};\n\nconst defaultOptions: TechDocsAddonTesterOptions = {\n  dom: <></>,\n  entity: {},\n  metadata: {},\n  componentId: 'docs',\n  apis: [],\n  path: '',\n};\n\nconst defaultMetadata = {\n  site_name: 'Tech Docs',\n  site_description: 'Tech Docs',\n};\n\nconst defaultEntity = {\n  kind: 'Component',\n  metadata: { namespace: 'default', name: 'docs' },\n};\n\nconst defaultDom = (\n  <html lang=\"en\">\n    <head />\n    <body>\n      <div data-md-component=\"container\">\n        <div data-md-component=\"navigation\" />\n        <div data-md-component=\"toc\" />\n        <div data-md-component=\"main\" />\n      </div>\n    </body>\n  </html>\n);\n\n/**\n * Utility class for rendering TechDocs Addons end-to-end within the TechDocs\n * reader page, with a set of givens (e.g. page DOM, metadata, etc).\n *\n * @example\n * ```tsx\n * const { getByText } = await TechDocsAddonTester.buildAddonsInTechDocs([<AnAddon />])\n *   .withDom(<body>TEST_CONTENT</body>)\n *   .renderWithEffects();\n *\n * expect(getByText('TEST_CONTENT')).toBeInTheDocument();\n * ```\n *\n * @public\n */\nexport class TechDocsAddonTester {\n  private options: TechDocsAddonTesterOptions = defaultOptions;\n  private addons: ReactElement[];\n\n  /**\n   * Get a TechDocsAddonTester instance for a given set of Addons.\n   */\n  static buildAddonsInTechDocs(addons: ReactElement[]) {\n    return new TechDocsAddonTester(addons);\n  }\n\n  // Protected in order to allow extension but not direct instantiation.\n  protected constructor(addons: ReactElement[]) {\n    this.addons = addons;\n  }\n\n  /**\n   * Provide mock API implementations if your Addon expects any.\n   */\n  withApis<T extends any[]>(apis: TechdocsAddonTesterApis<T>) {\n    const refs = apis.map(([ref]) => ref);\n    this.options.apis = this.options.apis\n      .filter(([ref]) => !refs.includes(ref))\n      .concat(apis);\n    return this;\n  }\n\n  /**\n   * Provide mock HTML if your Addon expects it in the shadow DOM.\n   */\n  withDom(dom: ReactElement) {\n    this.options.dom = dom;\n    return this;\n  }\n\n  /**\n   * Provide mock techdocs_metadata.json values if your Addon needs it.\n   */\n  withMetadata(metadata: Partial<TechDocsMetadata>) {\n    this.options.metadata = metadata;\n    return this;\n  }\n\n  /**\n   * Provide a mock entity if your Addon needs it. This also controls the base\n   * path at which the Addon is rendered.\n   */\n  withEntity(entity: Partial<TechDocsEntityMetadata>) {\n    this.options.entity = entity;\n    return this;\n  }\n\n  /**\n   * Provide the TechDocs page path at which the Addon is rendered (e.g. the\n   * part of the path after the entity namespace/kind/name).\n   */\n  atPath(path: string) {\n    this.options.path = path;\n    return this;\n  }\n\n  /**\n   * Return a fully configured and mocked TechDocs reader page within a test\n   * App instance, using the given Addon(s).\n   */\n  build() {\n    const apis: TechdocsAddonTesterApis<any[]> = [\n      [techdocsApiRef, techdocsApi],\n      [techdocsStorageApiRef, techdocsStorageApi],\n      [searchApiRef, searchApi],\n      [scmIntegrationsApiRef, scmIntegrationsApi],\n      ...this.options.apis,\n    ];\n\n    const entityName = {\n      namespace:\n        this.options.entity?.metadata?.namespace ||\n        defaultEntity.metadata.namespace,\n      kind: this.options.entity?.kind || defaultEntity.kind,\n      name: this.options.entity?.metadata?.name || defaultEntity.metadata.name,\n    };\n\n    techdocsApi.getTechDocsMetadata.mockReturnValue(\n      this.options.metadata || { ...defaultMetadata },\n    );\n    techdocsApi.getEntityMetadata.mockResolvedValue(\n      this.options.entity || { ...defaultEntity },\n    );\n\n    techdocsStorageApi.syncEntityDocs.mockResolvedValue('cached');\n    techdocsStorageApi.getApiOrigin.mockResolvedValue(\n      'https://backstage.example.com/api/techdocs',\n    );\n    techdocsStorageApi.getBaseUrl.mockResolvedValue(\n      `https://backstage.example.com/api/techdocs/${entityName.namespace}/${entityName.kind}/${entityName.name}/${this.options.path}`,\n    );\n    techdocsStorageApi.getEntityDocs.mockResolvedValue(\n      renderToStaticMarkup(this.options.dom || defaultDom),\n    );\n\n    const TechDocsAddonsPage = () => {\n      return (\n        <TestApiProvider apis={apis}>\n          <FlatRoutes>\n            <Route\n              path=\"/docs/:namespace/:kind/:name/*\"\n              element={<TechDocsReaderPage />}\n            >\n              <TechDocsAddons>\n                {this.addons.map((addon, index) => (\n                  <Fragment key={index}>{addon}</Fragment>\n                ))}\n              </TechDocsAddons>\n            </Route>\n          </FlatRoutes>\n        </TestApiProvider>\n      );\n    };\n\n    return wrapInTestApp(<TechDocsAddonsPage />, {\n      routeEntries: [\n        `/docs/${entityName.namespace}/${entityName.kind}/${entityName.name}/${this.options.path}`,\n      ],\n      mountedRoutes: {\n        '/docs': techdocsPlugin.routes.root,\n        '/docs/:namespace/:kind/:name/*': techdocsPlugin.routes.docRoot,\n        '/catalog/:namespace/:kind/:name': catalogPlugin.routes.catalogEntity,\n      },\n    });\n  }\n\n  /**\n   * Render the Addon within a fully configured and mocked TechDocs reader.\n   *\n   * @remarks\n   * Components using useEffect to perform an asynchronous action (such as\n   * fetch) must be rendered within an async act call to properly get the final\n   * state, even with mocked responses. This utility method makes the signature\n   * a bit cleaner, since act doesn't return the result of the evaluated\n   * function.\n   *\n   * @see https://github.com/testing-library/react-testing-library/issues/281\n   * @see https://github.com/facebook/react/pull/14853\n   */\n  async renderWithEffects(): Promise<\n    typeof screen & { shadowRoot: ShadowRoot | null }\n  > {\n    await act(async () => {\n      render(this.build());\n    });\n\n    const shadowHost = screen.getByTestId('techdocs-native-shadowroot');\n\n    return {\n      ...screen,\n      shadowRoot: shadowHost?.shadowRoot || null,\n    };\n  }\n}\n\nexport default TechDocsAddonTester.buildAddonsInTechDocs;\n"],"names":[],"mappings":"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"}