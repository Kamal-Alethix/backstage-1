{"version":3,"file":"index-28df527c.esm.js","sources":["../../src/hooks/useOctokitRequest.ts","../../src/components/AdrReader/decorators.ts","../../src/components/AdrReader/AdrReader.tsx","../../src/routes.ts","../../src/plugin.ts","../../src/search/AdrSearchResultListItem.tsx"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport parseGitUrl from 'git-url-parse';\nimport useAsync from 'react-use/lib/useAsync';\nimport { Octokit } from 'octokit';\nimport { useApi } from '@backstage/core-plugin-api';\nimport {\n  scmAuthApiRef,\n  scmIntegrationsApiRef,\n} from '@backstage/integration-react';\n\n/**\n * Hook for triggering authenticated Octokit requests against the GitHub Content API\n * @public\n */\nexport const useOctokitRequest = (request: string): any => {\n  const authApi = useApi(scmAuthApiRef);\n  const scmIntegrations = useApi(scmIntegrationsApiRef);\n\n  const { owner, name, ref, filepath } = parseGitUrl(request);\n  const path = filepath.replace(/^\\//, '');\n  const baseUrl = scmIntegrations.github.byUrl(request)?.config.apiBaseUrl;\n\n  return useAsync<any>(async () => {\n    const { token } = await authApi.getCredentials({\n      url: request,\n      additionalScope: {\n        customScopes: {\n          github: ['repo'],\n        },\n      },\n    });\n    const octokit = new Octokit({\n      auth: token,\n      baseUrl,\n    });\n\n    return octokit.request(\n      `GET /repos/${owner}/${name}/contents/${path}?ref=${ref}`,\n      {\n        headers: { Accept: 'application/vnd.github.v3.raw' },\n      },\n    );\n  }, [request]);\n};\n","/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { AdrContentDecorator } from './types';\n\n/**\n *\n * Factory for creating default ADR content decorators. The adrDecoratorFactories\n * symbol is not directly exported, but through the AdrReader.decorators field.\n * @public\n */\nexport const adrDecoratorFactories = Object.freeze({\n  /**\n   * Rewrites relative Markdown links as absolute links.\n   */\n  createRewriteRelativeLinksDecorator(): AdrContentDecorator {\n    return ({ baseUrl, content }) => ({\n      content: content.replace(\n        /\\[([^\\[\\]]*)\\]\\((?!https?:\\/\\/)(.*?)(\\.md)\\)/gim,\n        `[$1](${baseUrl}/$2$3)`,\n      ),\n    });\n  },\n  /**\n   * Rewrites relative Markdown embeds using absolute URLs.\n   */\n  createRewriteRelativeEmbedsDecorator(): AdrContentDecorator {\n    return ({ baseUrl, content }) => ({\n      content: content.replace(\n        /!\\[([^\\[\\]]*)\\]\\((?!https?:\\/\\/)(.*?)(\\.png|\\.jpg|\\.jpeg|\\.gif|\\.webp)(.*)\\)/gim,\n        `![$1](${baseUrl}/$2$3$4)`,\n      ),\n    });\n  },\n});\n","/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React, { useMemo } from 'react';\nimport {\n  InfoCard,\n  MarkdownContent,\n  Progress,\n  WarningPanel,\n} from '@backstage/core-components';\nimport { useApi } from '@backstage/core-plugin-api';\nimport { scmIntegrationsApiRef } from '@backstage/integration-react';\nimport { getAdrLocationUrl } from '@backstage/plugin-adr-common';\nimport { useEntity } from '@backstage/plugin-catalog-react';\n\nimport { useOctokitRequest } from '../../hooks';\nimport { adrDecoratorFactories } from './decorators';\nimport { AdrContentDecorator } from './types';\n\n/**\n * Component to fetch and render an ADR.\n * @public\n */\nexport const AdrReader = ({\n  adr,\n  decorators,\n}: {\n  adr: string;\n  decorators?: AdrContentDecorator[];\n}) => {\n  const { entity } = useEntity();\n  const scmIntegrations = useApi(scmIntegrationsApiRef);\n  const adrLocationUrl = getAdrLocationUrl(entity, scmIntegrations);\n\n  const { value, loading, error } = useOctokitRequest(\n    `${adrLocationUrl}/${adr}`,\n  );\n\n  const adrContent = useMemo(() => {\n    if (!value?.data) {\n      return '';\n    }\n    const adrDecorators = decorators ?? [\n      adrDecoratorFactories.createRewriteRelativeLinksDecorator(),\n      adrDecoratorFactories.createRewriteRelativeEmbedsDecorator(),\n    ];\n\n    return adrDecorators.reduce(\n      (content, decorator) =>\n        decorator({ baseUrl: adrLocationUrl, content }).content,\n      value.data,\n    );\n  }, [adrLocationUrl, decorators, value]);\n\n  return (\n    <InfoCard>\n      {loading && <Progress />}\n\n      {!loading && error && (\n        <WarningPanel title=\"Failed to fetch ADR\" message={error?.message} />\n      )}\n\n      {!loading && !error && value?.data && (\n        <MarkdownContent content={adrContent} linkTarget=\"_blank\" />\n      )}\n    </InfoCard>\n  );\n};\n\nAdrReader.decorators = adrDecoratorFactories;\n","/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { createRouteRef } from '@backstage/core-plugin-api';\n\n/**\n * Root route ref for the ADR plugin\n * @public\n */\nexport const rootRouteRef = createRouteRef({\n  id: 'adr',\n});\n","/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  createPlugin,\n  createRoutableExtension,\n} from '@backstage/core-plugin-api';\n\nimport { rootRouteRef } from './routes';\n\n/**\n * The Backstage plugin that holds ADR specific components\n * @public\n */\nexport const adrPlugin = createPlugin({\n  id: 'adr',\n  routes: {\n    root: rootRouteRef,\n  },\n});\n\n/**\n * An extension for browsing ADRs on an entity page.\n * @public\n */\nexport const EntityAdrContent = adrPlugin.provide(\n  createRoutableExtension({\n    name: 'EntityAdrContent',\n    component: () =>\n      import('./components/EntityAdrContent').then(m => m.EntityAdrContent),\n    mountPoint: rootRouteRef,\n  }),\n);\n","/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport React from 'react';\nimport {\n  Box,\n  Chip,\n  Divider,\n  ListItem,\n  ListItemText,\n  makeStyles,\n} from '@material-ui/core';\nimport { Link } from '@backstage/core-components';\nimport { AdrDocument } from '@backstage/plugin-adr-common';\nimport { ResultHighlight } from '@backstage/plugin-search-common';\nimport { HighlightedSearchResultText } from '@backstage/plugin-search-react';\n\nconst useStyles = makeStyles({\n  flexContainer: {\n    flexWrap: 'wrap',\n  },\n  itemText: {\n    width: '100%',\n    wordBreak: 'break-all',\n    marginBottom: '1rem',\n  },\n});\n\n/**\n * A component to display a ADR search result\n * @public\n */\nexport const AdrSearchResultListItem = ({\n  lineClamp = 5,\n  highlight,\n  result,\n}: {\n  lineClamp?: number;\n  highlight?: ResultHighlight;\n  result: AdrDocument;\n}) => {\n  const classes = useStyles();\n\n  return (\n    <Link to={result.location}>\n      <ListItem alignItems=\"flex-start\" className={classes.flexContainer}>\n        <ListItemText\n          className={classes.itemText}\n          primaryTypographyProps={{ variant: 'h6' }}\n          primary={\n            highlight?.fields.title ? (\n              <HighlightedSearchResultText\n                text={highlight.fields.title}\n                preTag={highlight.preTag}\n                postTag={highlight.postTag}\n              />\n            ) : (\n              result.title\n            )\n          }\n          secondary={\n            <span\n              style={{\n                display: '-webkit-box',\n                WebkitBoxOrient: 'vertical',\n                WebkitLineClamp: lineClamp,\n                overflow: 'hidden',\n              }}\n            >\n              {highlight?.fields.text ? (\n                <HighlightedSearchResultText\n                  text={highlight.fields.text}\n                  preTag={highlight.preTag}\n                  postTag={highlight.postTag}\n                />\n              ) : (\n                result.text\n              )}\n            </span>\n          }\n        />\n        <Box>\n          {result.status && (\n            <Chip label={`Status: ${result.status}`} size=\"small\" />\n          )}\n          {result.date && <Chip label={`Date: ${result.date}`} size=\"small\" />}\n        </Box>\n      </ListItem>\n      <Divider component=\"li\" />\n    </Link>\n  );\n};\n"],"names":[],"mappings":"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"}