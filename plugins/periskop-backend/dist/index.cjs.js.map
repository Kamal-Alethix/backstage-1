{"version":3,"file":"index.cjs.js","sources":["../src/api/index.ts","../src/service/router.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Config } from '@backstage/config';\nimport { AggregatedError, NotFoundInInstance } from '../types';\nimport fetch from 'node-fetch';\n\nexport type Options = {\n  config: Config;\n};\n\ntype PeriskopInstance = {\n  name: string;\n  url: string;\n};\n\nexport class PeriskopApi {\n  private readonly instances: PeriskopInstance[];\n\n  constructor(options: Options) {\n    this.instances = options.config\n      .getConfigArray('periskop.instances')\n      .flatMap(locConf => {\n        const name = locConf.getString('name');\n        const url = locConf.getString('url');\n        return { name: name, url: url };\n      });\n  }\n\n  private getApiUrl(instanceName: string): string | undefined {\n    return this.instances.find(instance => instance.name === instanceName)?.url;\n  }\n\n  async getErrors(\n    instanceName: string,\n    serviceName: string,\n  ): Promise<AggregatedError[] | NotFoundInInstance> {\n    const apiUrl = this.getApiUrl(instanceName);\n    if (!apiUrl) {\n      throw new Error(\n        `failed to fetch data, no periskop instance with name ${instanceName}`,\n      );\n    }\n    const response = await fetch(`${apiUrl}/services/${serviceName}/errors/`);\n\n    if (!response.ok) {\n      if (response.status === 404) {\n        return {\n          body: await response.text(),\n        };\n      }\n\n      throw new Error(\n        `failed to fetch data, status ${response.status}: ${response.statusText}`,\n      );\n    }\n    return response.json();\n  }\n}\n","/*\n * Copyright 2020 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { errorHandler } from '@backstage/backend-common';\nimport express from 'express';\nimport Router from 'express-promise-router';\nimport { Logger } from 'winston';\nimport { PeriskopApi } from '../api/index';\nimport { Config } from '@backstage/config';\n\n/**\n * @public\n */\nexport interface RouterOptions {\n  logger: Logger;\n  config: Config;\n}\n\n/**\n * @public\n */\nexport async function createRouter(\n  options: RouterOptions,\n): Promise<express.Router> {\n  const { logger, config } = options;\n  const periskopApi = new PeriskopApi({ config });\n\n  const router = Router();\n  router.use(express.json());\n\n  router.get('/health', (_, response) => {\n    logger.info('PONG!');\n    response.send({ status: 'ok' });\n  });\n\n  router.get('/:locationName/:serviceName', async (request, response) => {\n    const { locationName, serviceName } = request.params;\n    logger.info(`Periskop got queried for ${serviceName} in ${locationName}`);\n    const errors = await periskopApi.getErrors(locationName, serviceName);\n    response.status(200).json(errors);\n  });\n  router.use(errorHandler());\n  return router;\n}\n"],"names":["fetch","Router","express","errorHandler"],"mappings":"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"}