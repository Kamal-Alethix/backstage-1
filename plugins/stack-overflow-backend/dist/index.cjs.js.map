{"version":3,"file":"index.cjs.js","sources":["../src/search/StackOverflowQuestionsCollatorFactory.ts"],"sourcesContent":["/*\n * Copyright 2022 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  IndexableDocument,\n  DocumentCollatorFactory,\n} from '@backstage/plugin-search-common';\nimport { Config } from '@backstage/config';\nimport { Readable } from 'stream';\nimport fetch from 'cross-fetch';\nimport qs from 'qs';\nimport { Logger } from 'winston';\n\n/**\n * Extended IndexableDocument with stack overflow specific properties\n *\n * @public\n */\nexport interface StackOverflowDocument extends IndexableDocument {\n  answers: number;\n  tags: string[];\n}\n\n/**\n * Type representing the request parameters accepted by the {@link StackOverflowQuestionsCollatorFactory}\n *\n * @public\n */\nexport type StackOverflowQuestionsRequestParams = {\n  [key: string]: string | string[] | number;\n};\n\n/**\n * Options for {@link StackOverflowQuestionsCollatorFactory}\n *\n * @public\n */\nexport type StackOverflowQuestionsCollatorFactoryOptions = {\n  baseUrl?: string;\n  requestParams: StackOverflowQuestionsRequestParams;\n  logger: Logger;\n};\n\n/**\n * Search collator responsible for collecting stack overflow questions to index.\n *\n * @public\n */\nexport class StackOverflowQuestionsCollatorFactory\n  implements DocumentCollatorFactory\n{\n  protected requestParams: StackOverflowQuestionsRequestParams;\n  private readonly baseUrl: string | undefined;\n  private readonly logger: Logger;\n  public readonly type: string = 'stack-overflow';\n\n  private constructor(options: StackOverflowQuestionsCollatorFactoryOptions) {\n    this.baseUrl = options.baseUrl;\n    this.requestParams = options.requestParams;\n    this.logger = options.logger;\n  }\n\n  static fromConfig(\n    config: Config,\n    options: StackOverflowQuestionsCollatorFactoryOptions,\n  ) {\n    const baseUrl =\n      config.getOptionalString('stackoverflow.baseUrl') ||\n      'https://api.stackexchange.com/2.2';\n    return new StackOverflowQuestionsCollatorFactory({ ...options, baseUrl });\n  }\n\n  async getCollator() {\n    return Readable.from(this.execute());\n  }\n\n  async *execute(): AsyncGenerator<StackOverflowDocument> {\n    if (!this.baseUrl) {\n      this.logger.debug(\n        `No stackoverflow.baseUrl configured in your app-config.yaml`,\n      );\n    }\n    const params = qs.stringify(this.requestParams, {\n      arrayFormat: 'comma',\n      addQueryPrefix: true,\n    });\n\n    const res = await fetch(`${this.baseUrl}/questions${params}`);\n    const data = await res.json();\n\n    for (const question of data.items) {\n      yield {\n        title: question.title,\n        location: question.link,\n        text: question.owner.display_name,\n        tags: question.tags,\n        answers: question.answer_count,\n      };\n    }\n  }\n}\n"],"names":["Readable","qs","fetch"],"mappings":";;;;;;;;;;;;;AAGO,MAAM,qCAAqC,CAAC;AACnD,EAAE,WAAW,CAAC,OAAO,EAAE;AACvB,IAAI,IAAI,CAAC,IAAI,GAAG,gBAAgB,CAAC;AACjC,IAAI,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC,OAAO,CAAC;AACnC,IAAI,IAAI,CAAC,aAAa,GAAG,OAAO,CAAC,aAAa,CAAC;AAC/C,IAAI,IAAI,CAAC,MAAM,GAAG,OAAO,CAAC,MAAM,CAAC;AACjC,GAAG;AACH,EAAE,OAAO,UAAU,CAAC,MAAM,EAAE,OAAO,EAAE;AACrC,IAAI,MAAM,OAAO,GAAG,MAAM,CAAC,iBAAiB,CAAC,uBAAuB,CAAC,IAAI,mCAAmC,CAAC;AAC7G,IAAI,OAAO,IAAI,qCAAqC,CAAC,EAAE,GAAG,OAAO,EAAE,OAAO,EAAE,CAAC,CAAC;AAC9E,GAAG;AACH,EAAE,MAAM,WAAW,GAAG;AACtB,IAAI,OAAOA,eAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC,CAAC;AACzC,GAAG;AACH,EAAE,OAAO,OAAO,GAAG;AACnB,IAAI,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE;AACvB,MAAM,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,2DAA2D,CAAC,CAAC,CAAC;AACvF,KAAK;AACL,IAAI,MAAM,MAAM,GAAGC,sBAAE,CAAC,SAAS,CAAC,IAAI,CAAC,aAAa,EAAE;AACpD,MAAM,WAAW,EAAE,OAAO;AAC1B,MAAM,cAAc,EAAE,IAAI;AAC1B,KAAK,CAAC,CAAC;AACP,IAAI,MAAM,GAAG,GAAG,MAAMC,yBAAK,CAAC,CAAC,EAAE,IAAI,CAAC,OAAO,CAAC,UAAU,EAAE,MAAM,CAAC,CAAC,CAAC,CAAC;AAClE,IAAI,MAAM,IAAI,GAAG,MAAM,GAAG,CAAC,IAAI,EAAE,CAAC;AAClC,IAAI,KAAK,MAAM,QAAQ,IAAI,IAAI,CAAC,KAAK,EAAE;AACvC,MAAM,MAAM;AACZ,QAAQ,KAAK,EAAE,QAAQ,CAAC,KAAK;AAC7B,QAAQ,QAAQ,EAAE,QAAQ,CAAC,IAAI;AAC/B,QAAQ,IAAI,EAAE,QAAQ,CAAC,KAAK,CAAC,YAAY;AACzC,QAAQ,IAAI,EAAE,QAAQ,CAAC,IAAI;AAC3B,QAAQ,OAAO,EAAE,QAAQ,CAAC,YAAY;AACtC,OAAO,CAAC;AACR,KAAK;AACL,GAAG;AACH;;;;"}