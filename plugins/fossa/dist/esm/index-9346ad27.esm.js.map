{"version":3,"file":"index-9346ad27.esm.js","sources":["../../src/components/FossaPage/FossaPage.tsx"],"sourcesContent":["/*\n * Copyright 2021 The Backstage Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  Entity,\n  CompoundEntityRef,\n  RELATION_OWNED_BY,\n} from '@backstage/catalog-model';\nimport {\n  catalogApiRef,\n  EntityRefLink,\n  EntityRefLinks,\n  humanizeEntityRef,\n  getEntityRelations,\n} from '@backstage/plugin-catalog-react';\nimport { Tooltip } from '@material-ui/core';\nimport { Skeleton } from '@material-ui/lab';\nimport { DateTime } from 'luxon';\nimport * as React from 'react';\nimport { useMemo, useState } from 'react';\nimport useAsync from 'react-use/lib/useAsync';\nimport useDeepCompareEffect from 'react-use/lib/useDeepCompareEffect';\nimport { FindingSummary, fossaApiRef } from '../../api';\nimport { getProjectName } from '../getProjectName';\n\nimport {\n  Content,\n  Header,\n  Link,\n  Page,\n  StatusError,\n  StatusOK,\n  StatusWarning,\n  Table,\n  TableColumn,\n  TableFilter,\n} from '@backstage/core-components';\n\nimport { useApi } from '@backstage/core-plugin-api';\n\ntype FossaRow = {\n  entity: Entity;\n  resolved: {\n    name: string;\n    ownedByRelationsTitle?: string;\n    ownedByRelations: CompoundEntityRef[];\n    loading: boolean;\n    details?: FindingSummary;\n  };\n};\n\nconst columns: TableColumn<FossaRow>[] = [\n  {\n    title: 'Name',\n    field: 'resolved.name',\n    highlight: true,\n    width: 'auto',\n    render: ({ entity }) => (\n      <EntityRefLink entityRef={entity} defaultKind=\"Component\" />\n    ),\n  },\n  {\n    title: 'Owner',\n    field: 'resolved.ownedByRelationsTitle',\n    render: ({ resolved }) => (\n      <EntityRefLinks\n        entityRefs={resolved.ownedByRelations}\n        defaultKind=\"group\"\n      />\n    ),\n  },\n  {\n    title: 'Status',\n    field: 'resolved.details.issueCount',\n    // We interpret missing values as '0.5' to be sorted at the end of the projects with issues.\n    customSort: (a, b) =>\n      (b?.resolved?.details?.issueCount ?? 0.5) -\n      (a?.resolved?.details?.issueCount ?? 0.5),\n    render: ({ resolved }) => {\n      if (resolved.loading) {\n        return <Skeleton animation=\"pulse\" />;\n      } else if (!resolved.details) {\n        return <StatusWarning>Not configured</StatusWarning>;\n      } else if (resolved.details.dependencyCount === 0) {\n        return <StatusWarning>No dependencies</StatusWarning>;\n      } else if (resolved.details.issueCount > 0) {\n        return <StatusError>{resolved.details.issueCount} Issues</StatusError>;\n      }\n\n      return <StatusOK>{resolved.details.issueCount} Issues</StatusOK>;\n    },\n  },\n  {\n    title: 'Dependencies',\n    field: 'resolved.details.dependencyCount',\n    render: ({ resolved: { loading, details } }) => {\n      if (loading) {\n        return <Skeleton animation=\"pulse\" />;\n      }\n\n      return details?.dependencyCount;\n    },\n  },\n  {\n    title: 'Branch',\n    field: 'resolved.details.projectDefaultBranch',\n    render: ({ resolved: { loading, details } }) => {\n      if (loading) {\n        return <Skeleton animation=\"pulse\" />;\n      }\n\n      return details?.projectDefaultBranch;\n    },\n  },\n  {\n    title: 'Last Updated',\n    field: 'resolved.details.timestamp',\n    render: ({ resolved: { loading, details } }) => {\n      if (loading) {\n        return <Skeleton animation=\"pulse\" />;\n      }\n\n      return (\n        details?.timestamp && (\n          <Tooltip\n            title={DateTime.fromISO(details.timestamp).toLocaleString(\n              DateTime.DATETIME_MED,\n            )}\n          >\n            <span>\n              {DateTime.fromISO(details.timestamp).toRelative({\n                locale: 'en',\n              })}\n            </span>\n          </Tooltip>\n        )\n      );\n    },\n  },\n  {\n    sorting: false,\n    render: ({ resolved: { loading, details } }) => {\n      if (loading) {\n        return <Skeleton animation=\"pulse\" />;\n      }\n\n      return details && <Link to={details.projectUrl}>View in FOSSA</Link>;\n    },\n  },\n];\n\nconst filters: TableFilter[] = [\n  { column: 'Owner', type: 'multiple-select' },\n  { column: 'Branch', type: 'select' },\n];\n\nexport type FossaPageProps = {\n  entitiesFilter?:\n    | Record<string, string | symbol | (string | symbol)[]>[]\n    | Record<string, string | symbol | (string | symbol)[]>\n    | undefined;\n};\n\nexport const FossaPage = ({\n  entitiesFilter = { kind: 'Component' },\n}: FossaPageProps) => {\n  const catalogApi = useApi(catalogApiRef);\n  const fossaApi = useApi(fossaApiRef);\n  const [filter, setFilter] = useState(entitiesFilter);\n  useDeepCompareEffect(() => setFilter(entitiesFilter), [entitiesFilter]);\n\n  // Get a list of all relevant entities\n  const { value: entities, loading: entitiesLoading } = useAsync(() => {\n    return catalogApi.getEntities({\n      filter,\n      fields: [\n        'kind',\n        'metadata.namespace',\n        'metadata.name',\n        'metadata.annotations',\n        'relations',\n      ],\n    });\n  }, [filter]);\n\n  // get the project names of all entities. the idx of both lists match.\n  const projectNames = useMemo(\n    () => entities?.items?.map(getProjectName) ?? [],\n    [entities?.items],\n  );\n\n  // get the summary list\n  const { value: summaries, loading: summariesLoading } = useAsync(\n    async () =>\n      await fossaApi.getFindingSummaries(\n        projectNames.filter(n => n !== undefined) as string[],\n      ),\n    [projectNames],\n  );\n\n  // compose the rows\n  const rows: FossaRow[] = useMemo(\n    () =>\n      entities?.items?.map((entity, idx) => {\n        const projectName = projectNames[idx];\n        const summary = projectName ? summaries?.get(projectName) : undefined;\n        const ownedByRelations = getEntityRelations(entity, RELATION_OWNED_BY);\n\n        return {\n          entity,\n          resolved: {\n            name: humanizeEntityRef(entity),\n            ownedByRelations,\n            ownedByRelationsTitle: ownedByRelations\n              .map(r => humanizeEntityRef(r, { defaultKind: 'group' }))\n              .join(', '),\n            loading: summariesLoading,\n            details: summary,\n          },\n        };\n      }) ?? [],\n    [projectNames, entities?.items, summaries, summariesLoading],\n  );\n\n  return (\n    <Page themeId=\"home\">\n      <Header title=\"FOSSA Component Overview\" />\n      <Content>\n        <Table<FossaRow>\n          columns={columns}\n          data={rows}\n          filters={filters}\n          isLoading={entitiesLoading}\n          options={{\n            pageSize: 20,\n            actionsColumnIndex: -1,\n            loadingType: 'linear',\n            padding: 'dense',\n            showEmptyDataSourceMessage: !entitiesLoading,\n          }}\n        />\n      </Content>\n    </Page>\n  );\n};\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;AA8BA,MAAM,OAAO,GAAG;AAChB,EAAE;AACF,IAAI,KAAK,EAAE,MAAM;AACjB,IAAI,KAAK,EAAE,eAAe;AAC1B,IAAI,SAAS,EAAE,IAAI;AACnB,IAAI,KAAK,EAAE,MAAM;AACjB,IAAI,MAAM,EAAE,CAAC,EAAE,MAAM,EAAE,qBAAqB,KAAK,CAAC,aAAa,CAAC,aAAa,EAAE;AAC/E,MAAM,SAAS,EAAE,MAAM;AACvB,MAAM,WAAW,EAAE,WAAW;AAC9B,KAAK,CAAC;AACN,GAAG;AACH,EAAE;AACF,IAAI,KAAK,EAAE,OAAO;AAClB,IAAI,KAAK,EAAE,gCAAgC;AAC3C,IAAI,MAAM,EAAE,CAAC,EAAE,QAAQ,EAAE,qBAAqB,KAAK,CAAC,aAAa,CAAC,cAAc,EAAE;AAClF,MAAM,UAAU,EAAE,QAAQ,CAAC,gBAAgB;AAC3C,MAAM,WAAW,EAAE,OAAO;AAC1B,KAAK,CAAC;AACN,GAAG;AACH,EAAE;AACF,IAAI,KAAK,EAAE,QAAQ;AACnB,IAAI,KAAK,EAAE,6BAA6B;AACxC,IAAI,UAAU,EAAE,CAAC,CAAC,EAAE,CAAC,KAAK;AAC1B,MAAM,IAAI,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,CAAC;AACjC,MAAM,OAAO,CAAC,CAAC,EAAE,GAAG,CAAC,EAAE,GAAG,CAAC,EAAE,GAAG,CAAC,IAAI,IAAI,GAAG,KAAK,CAAC,GAAG,CAAC,CAAC,QAAQ,KAAK,IAAI,GAAG,KAAK,CAAC,GAAG,EAAE,CAAC,OAAO,KAAK,IAAI,GAAG,KAAK,CAAC,GAAG,EAAE,CAAC,UAAU,KAAK,IAAI,GAAG,EAAE,GAAG,GAAG,KAAK,CAAC,EAAE,GAAG,CAAC,EAAE,GAAG,CAAC,EAAE,GAAG,CAAC,IAAI,IAAI,GAAG,KAAK,CAAC,GAAG,CAAC,CAAC,QAAQ,KAAK,IAAI,GAAG,KAAK,CAAC,GAAG,EAAE,CAAC,OAAO,KAAK,IAAI,GAAG,KAAK,CAAC,GAAG,EAAE,CAAC,UAAU,KAAK,IAAI,GAAG,EAAE,GAAG,GAAG,CAAC,CAAC;AACjS,KAAK;AACL,IAAI,MAAM,EAAE,CAAC,EAAE,QAAQ,EAAE,KAAK;AAC9B,MAAM,IAAI,QAAQ,CAAC,OAAO,EAAE;AAC5B,QAAQ,uBAAuB,KAAK,CAAC,aAAa,CAAC,QAAQ,EAAE;AAC7D,UAAU,SAAS,EAAE,OAAO;AAC5B,SAAS,CAAC,CAAC;AACX,OAAO,MAAM,IAAI,CAAC,QAAQ,CAAC,OAAO,EAAE;AACpC,QAAQ,uBAAuB,KAAK,CAAC,aAAa,CAAC,aAAa,EAAE,IAAI,EAAE,gBAAgB,CAAC,CAAC;AAC1F,OAAO,MAAM,IAAI,QAAQ,CAAC,OAAO,CAAC,eAAe,KAAK,CAAC,EAAE;AACzD,QAAQ,uBAAuB,KAAK,CAAC,aAAa,CAAC,aAAa,EAAE,IAAI,EAAE,iBAAiB,CAAC,CAAC;AAC3F,OAAO,MAAM,IAAI,QAAQ,CAAC,OAAO,CAAC,UAAU,GAAG,CAAC,EAAE;AAClD,QAAQ,uBAAuB,KAAK,CAAC,aAAa,CAAC,WAAW,EAAE,IAAI,EAAE,QAAQ,CAAC,OAAO,CAAC,UAAU,EAAE,SAAS,CAAC,CAAC;AAC9G,OAAO;AACP,MAAM,uBAAuB,KAAK,CAAC,aAAa,CAAC,QAAQ,EAAE,IAAI,EAAE,QAAQ,CAAC,OAAO,CAAC,UAAU,EAAE,SAAS,CAAC,CAAC;AACzG,KAAK;AACL,GAAG;AACH,EAAE;AACF,IAAI,KAAK,EAAE,cAAc;AACzB,IAAI,KAAK,EAAE,kCAAkC;AAC7C,IAAI,MAAM,EAAE,CAAC,EAAE,QAAQ,EAAE,EAAE,OAAO,EAAE,OAAO,EAAE,EAAE,KAAK;AACpD,MAAM,IAAI,OAAO,EAAE;AACnB,QAAQ,uBAAuB,KAAK,CAAC,aAAa,CAAC,QAAQ,EAAE;AAC7D,UAAU,SAAS,EAAE,OAAO;AAC5B,SAAS,CAAC,CAAC;AACX,OAAO;AACP,MAAM,OAAO,OAAO,IAAI,IAAI,GAAG,KAAK,CAAC,GAAG,OAAO,CAAC,eAAe,CAAC;AAChE,KAAK;AACL,GAAG;AACH,EAAE;AACF,IAAI,KAAK,EAAE,QAAQ;AACnB,IAAI,KAAK,EAAE,uCAAuC;AAClD,IAAI,MAAM,EAAE,CAAC,EAAE,QAAQ,EAAE,EAAE,OAAO,EAAE,OAAO,EAAE,EAAE,KAAK;AACpD,MAAM,IAAI,OAAO,EAAE;AACnB,QAAQ,uBAAuB,KAAK,CAAC,aAAa,CAAC,QAAQ,EAAE;AAC7D,UAAU,SAAS,EAAE,OAAO;AAC5B,SAAS,CAAC,CAAC;AACX,OAAO;AACP,MAAM,OAAO,OAAO,IAAI,IAAI,GAAG,KAAK,CAAC,GAAG,OAAO,CAAC,oBAAoB,CAAC;AACrE,KAAK;AACL,GAAG;AACH,EAAE;AACF,IAAI,KAAK,EAAE,cAAc;AACzB,IAAI,KAAK,EAAE,4BAA4B;AACvC,IAAI,MAAM,EAAE,CAAC,EAAE,QAAQ,EAAE,EAAE,OAAO,EAAE,OAAO,EAAE,EAAE,KAAK;AACpD,MAAM,IAAI,OAAO,EAAE;AACnB,QAAQ,uBAAuB,KAAK,CAAC,aAAa,CAAC,QAAQ,EAAE;AAC7D,UAAU,SAAS,EAAE,OAAO;AAC5B,SAAS,CAAC,CAAC;AACX,OAAO;AACP,MAAM,OAAO,CAAC,OAAO,IAAI,IAAI,GAAG,KAAK,CAAC,GAAG,OAAO,CAAC,SAAS,qBAAqB,KAAK,CAAC,aAAa,CAAC,OAAO,EAAE;AAC5G,QAAQ,KAAK,EAAE,QAAQ,CAAC,OAAO,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC,cAAc,CAAC,QAAQ,CAAC,YAAY,CAAC;AACxF,OAAO,kBAAkB,KAAK,CAAC,aAAa,CAAC,MAAM,EAAE,IAAI,EAAE,QAAQ,CAAC,OAAO,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC,UAAU,CAAC;AAC1G,QAAQ,MAAM,EAAE,IAAI;AACpB,OAAO,CAAC,CAAC,CAAC,CAAC;AACX,KAAK;AACL,GAAG;AACH,EAAE;AACF,IAAI,OAAO,EAAE,KAAK;AAClB,IAAI,MAAM,EAAE,CAAC,EAAE,QAAQ,EAAE,EAAE,OAAO,EAAE,OAAO,EAAE,EAAE,KAAK;AACpD,MAAM,IAAI,OAAO,EAAE;AACnB,QAAQ,uBAAuB,KAAK,CAAC,aAAa,CAAC,QAAQ,EAAE;AAC7D,UAAU,SAAS,EAAE,OAAO;AAC5B,SAAS,CAAC,CAAC;AACX,OAAO;AACP,MAAM,OAAO,OAAO,oBAAoB,KAAK,CAAC,aAAa,CAAC,IAAI,EAAE;AAClE,QAAQ,EAAE,EAAE,OAAO,CAAC,UAAU;AAC9B,OAAO,EAAE,eAAe,CAAC,CAAC;AAC1B,KAAK;AACL,GAAG;AACH,CAAC,CAAC;AACF,MAAM,OAAO,GAAG;AAChB,EAAE,EAAE,MAAM,EAAE,OAAO,EAAE,IAAI,EAAE,iBAAiB,EAAE;AAC9C,EAAE,EAAE,MAAM,EAAE,QAAQ,EAAE,IAAI,EAAE,QAAQ,EAAE;AACtC,CAAC,CAAC;AACU,MAAC,SAAS,GAAG,CAAC;AAC1B,EAAE,cAAc,GAAG,EAAE,IAAI,EAAE,WAAW,EAAE;AACxC,CAAC,KAAK;AACN,EAAE,MAAM,UAAU,GAAG,MAAM,CAAC,aAAa,CAAC,CAAC;AAC3C,EAAE,MAAM,QAAQ,GAAG,MAAM,CAAC,WAAW,CAAC,CAAC;AACvC,EAAE,MAAM,CAAC,MAAM,EAAE,SAAS,CAAC,GAAG,QAAQ,CAAC,cAAc,CAAC,CAAC;AACvD,EAAE,oBAAoB,CAAC,MAAM,SAAS,CAAC,cAAc,CAAC,EAAE,CAAC,cAAc,CAAC,CAAC,CAAC;AAC1E,EAAE,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,OAAO,EAAE,eAAe,EAAE,GAAG,QAAQ,CAAC,MAAM;AACvE,IAAI,OAAO,UAAU,CAAC,WAAW,CAAC;AAClC,MAAM,MAAM;AACZ,MAAM,MAAM,EAAE;AACd,QAAQ,MAAM;AACd,QAAQ,oBAAoB;AAC5B,QAAQ,eAAe;AACvB,QAAQ,sBAAsB;AAC9B,QAAQ,WAAW;AACnB,OAAO;AACP,KAAK,CAAC,CAAC;AACP,GAAG,EAAE,CAAC,MAAM,CAAC,CAAC,CAAC;AACf,EAAE,MAAM,YAAY,GAAG,OAAO,CAAC,MAAM;AACrC,IAAI,IAAI,EAAE,EAAE,EAAE,CAAC;AACf,IAAI,OAAO,CAAC,EAAE,GAAG,CAAC,EAAE,GAAG,QAAQ,IAAI,IAAI,GAAG,KAAK,CAAC,GAAG,QAAQ,CAAC,KAAK,KAAK,IAAI,GAAG,KAAK,CAAC,GAAG,EAAE,CAAC,GAAG,CAAC,cAAc,CAAC,KAAK,IAAI,GAAG,EAAE,GAAG,EAAE,CAAC;AAChI,GAAG,EAAE,CAAC,QAAQ,IAAI,IAAI,GAAG,KAAK,CAAC,GAAG,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC;AACnD,EAAE,MAAM,EAAE,KAAK,EAAE,SAAS,EAAE,OAAO,EAAE,gBAAgB,EAAE,GAAG,QAAQ,CAAC,YAAY,MAAM,QAAQ,CAAC,mBAAmB,CAAC,YAAY,CAAC,MAAM,CAAC,CAAC,CAAC,KAAK,CAAC,KAAK,KAAK,CAAC,CAAC,CAAC,EAAE,CAAC,YAAY,CAAC,CAAC,CAAC;AAC7K,EAAE,MAAM,IAAI,GAAG,OAAO,CAAC,MAAM;AAC7B,IAAI,IAAI,EAAE,EAAE,EAAE,CAAC;AACf,IAAI,OAAO,CAAC,EAAE,GAAG,CAAC,EAAE,GAAG,QAAQ,IAAI,IAAI,GAAG,KAAK,CAAC,GAAG,QAAQ,CAAC,KAAK,KAAK,IAAI,GAAG,KAAK,CAAC,GAAG,EAAE,CAAC,GAAG,CAAC,CAAC,MAAM,EAAE,GAAG,KAAK;AAC9G,MAAM,MAAM,WAAW,GAAG,YAAY,CAAC,GAAG,CAAC,CAAC;AAC5C,MAAM,MAAM,OAAO,GAAG,WAAW,GAAG,SAAS,IAAI,IAAI,GAAG,KAAK,CAAC,GAAG,SAAS,CAAC,GAAG,CAAC,WAAW,CAAC,GAAG,KAAK,CAAC,CAAC;AACrG,MAAM,MAAM,gBAAgB,GAAG,kBAAkB,CAAC,MAAM,EAAE,iBAAiB,CAAC,CAAC;AAC7E,MAAM,OAAO;AACb,QAAQ,MAAM;AACd,QAAQ,QAAQ,EAAE;AAClB,UAAU,IAAI,EAAE,iBAAiB,CAAC,MAAM,CAAC;AACzC,UAAU,gBAAgB;AAC1B,UAAU,qBAAqB,EAAE,gBAAgB,CAAC,GAAG,CAAC,CAAC,CAAC,KAAK,iBAAiB,CAAC,CAAC,EAAE,EAAE,WAAW,EAAE,OAAO,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC;AACvH,UAAU,OAAO,EAAE,gBAAgB;AACnC,UAAU,OAAO,EAAE,OAAO;AAC1B,SAAS;AACT,OAAO,CAAC;AACR,KAAK,CAAC,KAAK,IAAI,GAAG,EAAE,GAAG,EAAE,CAAC;AAC1B,GAAG,EAAE,CAAC,YAAY,EAAE,QAAQ,IAAI,IAAI,GAAG,KAAK,CAAC,GAAG,QAAQ,CAAC,KAAK,EAAE,SAAS,EAAE,gBAAgB,CAAC,CAAC,CAAC;AAC9F,EAAE,uBAAuB,KAAK,CAAC,aAAa,CAAC,IAAI,EAAE;AACnD,IAAI,OAAO,EAAE,MAAM;AACnB,GAAG,kBAAkB,KAAK,CAAC,aAAa,CAAC,MAAM,EAAE;AACjD,IAAI,KAAK,EAAE,0BAA0B;AACrC,GAAG,CAAC,kBAAkB,KAAK,CAAC,aAAa,CAAC,OAAO,EAAE,IAAI,kBAAkB,KAAK,CAAC,aAAa,CAAC,KAAK,EAAE;AACpG,IAAI,OAAO;AACX,IAAI,IAAI,EAAE,IAAI;AACd,IAAI,OAAO;AACX,IAAI,SAAS,EAAE,eAAe;AAC9B,IAAI,OAAO,EAAE;AACb,MAAM,QAAQ,EAAE,EAAE;AAClB,MAAM,kBAAkB,EAAE,CAAC,CAAC;AAC5B,MAAM,WAAW,EAAE,QAAQ;AAC3B,MAAM,OAAO,EAAE,OAAO;AACtB,MAAM,0BAA0B,EAAE,CAAC,eAAe;AAClD,KAAK;AACL,GAAG,CAAC,CAAC,CAAC,CAAC;AACP;;;;"}